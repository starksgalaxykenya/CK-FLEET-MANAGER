<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cars Kenya - Fleet Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kenya-green': {
                            50: '#f0f9f0',
                            100: '#dcf0dc',
                            200: '#b9e2b9',
                            300: '#8bd08b',
                            400: '#5cba5c',
                            500: '#3da33d',
                            600: '#188301',
                            700: '#1a5e1a',
                            800: '#164d16',
                            900: '#134113',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* 1. Darker background */
        body.bg-gray-50 {
            background-color: #f9fafb !important;
        }
        
        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.08);
        }
        
        .stage-indicator {
            height: 6px;
            border-radius: 3px;
            transition: all 0.5s ease;
        }
        
        .success-delivery {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(24, 131, 1, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(24, 131, 1, 0); }
            100% { box-shadow: 0 0 0 0 rgba(24, 131, 1, 0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Stage colors - using Kenya Green shades */
        .stage-due-to-ship { background-color: #f0f9f0; color: #134113; }
        .stage-on-voyage { background-color: #dcf0dc; color: #1a5e1a; }
        .stage-on-port { background-color: #b9e2b9; color: #164d16; }
        .stage-clearing { background-color: #8bd08b; color: #134113; }
        .stage-due-to-carrier { background-color: #5cba5c; color: #ffffff; }
        .stage-on-carrier { background-color: #3da33d; color: #ffffff; }
        .stage-on-transit { background-color: #188301; color: #ffffff; }
        .stage-arrived { background-color: #1a5e1a; color: #ffffff; }
        .stage-due-for-delivery { background-color: #164d16; color: #ffffff; }
        .stage-delivered { background-color: #134113; color: #ffffff; }
        .stage-due-for-sale { background-color: #5cba5c; color: #ffffff; }
        .stage-picked-by-client { background-color: #8bd08b; color: #134113; }
        
        /* Stage indicator colors */
        .indicator-due-to-ship { background-color: #f0f9f0; }
        .indicator-on-voyage { background-color: #dcf0dc; }
        .indicator-on-port { background-color: #b9e2b9; }
        .indicator-clearing { background-color: #8bd08b; }
        .indicator-due-to-carrier { background-color: #5cba5c; }
        .indicator-on-carrier { background-color: #3da33d; }
        .indicator-on-transit { background-color: #188301; }
        .indicator-arrived { background-color: #1a5e1a; }
        .indicator-due-for-delivery { background-color: #164d16; }
        .indicator-delivered { background-color: #134113; }
        .indicator-due-for-sale { background-color: #5cba5c; }
        .indicator-picked-by-client { background-color: #8bd08b; }
        
        .tab-active {
            border-bottom: 3px solid #188301;
            color: #188301;
            font-weight: 600;
        }
        
        .login-form {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #188301;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 2. Better mobile scaling */
        @media (max-width: 640px) {
            .main-container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .card-grid {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .flex-mobile-col {
                flex-direction: column;
            }
            
            .text-mobile-center {
                text-align: center;
            }
            
            .stage-filter-buttons {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
            }
            
            .stage-filter-btn {
                white-space: nowrap;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            .card-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* 3. Edit car form styling */
        .edit-form-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        
        .edit-form-container.expanded {
            max-height: 2000px;
            overflow: visible;
        }
        
        /* 5. Description truncation and copy button */
        .truncated-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .full-text {
            display: block;
            max-height: none;
        }
        
        .description-container {
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            opacity: 1;
        }
        
        /* 6. Stage filter improvements */
        .stage-filter-container {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* 7. Photo upload and display */
        .photo-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .photo-placeholder {
            width: 100%;
            height: 200px;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            color: #6b7280;
        }
        
        .photo-upload-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            background-color: #188301;
            color: white;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 0.5rem;
        }
        
        .photo-upload-btn:hover {
            background-color: #1a5e1a;
        }
        
        .car-photo {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .photo-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Deal status colors */
        .deal-hot { background-color: #fee2e2; color: #dc2626; }
        .deal-deposit { background-color: #dbeafe; color: #1d4ed8; }
        .deal-finalised { background-color: #dcfce7; color: #15803d; }
        
        /* Deal indicator colors */
        .indicator-hot { background-color: #fecaca; }
        .indicator-deposit { background-color: #bfdbfe; }
        .indicator-finalised { background-color: #bbf7d0; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-kenya-green-50 to-kenya-green-100 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full login-form">
            <div class="flex justify-center mb-8">
                <div class="bg-kenya-green-600 text-white p-4 rounded-xl">
                    <i class="fas fa-car text-3xl"></i>
                </div>
            </div>
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Cars Kenya</h2>
            <p class="text-center text-gray-600 mb-8">Fleet Management Dashboard</p>
            
            <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                Invalid email or password
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="admin@carskenya.com" value="admin@carskenya.com">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Enter password" value="password123">
                </div>
                <button id="loginBtn" class="w-full bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 transform hover:-translate-y-1 flex items-center justify-center">
                    <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                    <div id="loginSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </div>
            
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>Default Credentials:</p>
                <p>Email: admin@carskenya.com</p>
                <p>Password: password123</p>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-kenya-green-600 text-white p-3 rounded-xl mr-4">
                            <i class="fas fa-car text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Cars Kenya - Fleet Management</h1>
                            <p class="text-gray-600">Track vehicle movement from exporter to Nairobi</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div id="userInfo" class="hidden md:block text-right">
                            <p class="font-medium text-gray-800" id="userName">Admin User</p>
                            <p class="text-sm text-gray-600" id="userEmail">admin@carskenya.com</p>
                        </div>
                        <button id="logoutBtn" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-lg transition">
                            <i class="fas fa-sign-out-alt mr-2"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="mt-6 border-b border-gray-200">
                    <nav class="flex overflow-x-auto custom-scrollbar" id="tabs">
                        <button class="tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-tab="all-cars">
                            <i class="fas fa-car mr-2"></i>All Cars
                        </button>
                        <button class="tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-tab="successful-deliveries">
                            <i class="fas fa-check-circle mr-2"></i>Successful Deliveries
                        </button>
                        <button class="tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-tab="deals">
                            <i class="fas fa-handshake mr-2"></i>Deals
                        </button>
                        <button class="tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-tab="admin">
                            <i class="fas fa-user-cog mr-2"></i>Admin Panel
                        </button>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- All Cars Tab -->
            <div id="all-cars-tab" class="tab-content fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">All Vehicles in Transit</h2>
                        <p class="text-gray-600">Track the movement of sold cars from exporter to Nairobi</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <div class="flex items-center space-x-2">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="searchInput" class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Search by make, model...">
                            </div>
                            <select id="filterStage" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition">
                                <option value="">All Stages</option>
                                <option value="Due to ship">Due to ship</option>
                                <option value="On voyage">On voyage</option>
                                <option value="On port">On port</option>
                                <option value="Clearing">Clearing</option>
                                <option value="Due to carrier">Due to carrier</option>
                                <option value="On carrier">On carrier</option>
                                <option value="On transit to Nairobi">On transit to Nairobi</option>
                                <option value="Arrived to Nairobi">Arrived to Nairobi</option>
                                <option value="Due for delivery">Due for delivery</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Due for sale in Nairobi">Due for sale in Nairobi</option>
                                <option value="Picked by client from Mombasa">Picked by client from Mombasa</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 6. Stage Filter -->
                <div class="stage-filter-container mb-6">
                    <h3 class="font-bold text-gray-800 mb-3">Filter by Stage:</h3>
                    <div class="flex flex-wrap gap-2 stage-filter-buttons" id="stageFilterButtons">
                        <button class="stage-filter-btn px-3 py-2 rounded-lg text-sm font-medium bg-kenya-green-600 text-white hover:bg-kenya-green-700 transition" data-stage="">
                            All Stages
                        </button>
                        <!-- Stage buttons will be dynamically added -->
                    </div>
                </div>
                
                <div id="allCarsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 card-grid">
                    <!-- Cars will be dynamically added here -->
                    <div class="text-center py-12 text-gray-500" id="loadingCars">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p>Loading vehicles...</p>
                    </div>
                </div>
            </div>
            
            <!-- Successful Deliveries Tab -->
            <div id="successful-deliveries-tab" class="tab-content hidden fade-in">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Successful Deliveries</h2>
                    <p class="text-gray-600">Cars that have been marked as delivered</p>
                </div>
                
                <div id="successfulDeliveriesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 card-grid">
                    <!-- Successful deliveries will be dynamically added here -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-check-circle text-3xl mb-4 text-kenya-green-600"></i>
                        <p>No successful deliveries yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Deals Tab -->
            <div id="deals-tab" class="tab-content hidden fade-in">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Deals Management</h2>
                    <p class="text-gray-600">Manage hot deals, deposits, and finalised sales</p>
                </div>
                
                <!-- Deals Sub-tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex overflow-x-auto custom-scrollbar" id="dealsTabs">
                        <button class="deals-tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-deals-tab="hot-deals">
                            <i class="fas fa-fire mr-2"></i>Hot Deals
                        </button>
                        <button class="deals-tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-deals-tab="deposits">
                            <i class="fas fa-money-bill-wave mr-2"></i>Deposits
                        </button>
                        <button class="deals-tab-btn py-3 px-4 font-medium text-gray-600 hover:text-kenya-green-600 whitespace-nowrap" data-deals-tab="finalised">
                            <i class="fas fa-check-double mr-2"></i>Finalised
                        </button>
                    </nav>
                </div>
                
                <!-- Hot Deals Sub-tab -->
                <div id="hot-deals-tab" class="deals-tab-content fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Hot Deals</h3>
                            <p class="text-gray-600">Potential deals that need attention</p>
                        </div>
                        <button id="addHotDealBtn" class="mt-4 md:mt-0 bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                            <i class="fas fa-plus mr-2"></i> Add Hot Deal
                        </button>
                    </div>
                    
                    <!-- Add Hot Deal Form -->
                    <div id="addHotDealForm" class="bg-white rounded-xl shadow-lg p-6 card mb-8 hidden">
                        <h4 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                            <span><i class="fas fa-plus-circle mr-2 text-kenya-green-600"></i> Add New Hot Deal</span>
                            <button id="closeHotDealForm" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </h4>
                        
                        <div id="hotDealError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                        <div id="hotDealSuccess" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
                        
                        <form id="hotDealForm" class="space-y-4">
                            <!-- Photo Upload -->
                            <div>
                                <label class="block text-gray-700 mb-2">Car Photo (Optional)</label>
                                <div id="hotDealPhotoPreview" class="photo-placeholder">
                                    <i class="fas fa-car text-4xl"></i>
                                </div>
                                <div class="photo-actions">
                                    <input type="file" id="hotDealPhoto" accept="image/*" class="hidden" />
                                    <label for="hotDealPhoto" class="photo-upload-btn">
                                        <i class="fas fa-camera mr-2"></i> Upload Photo
                                    </label>
                                    <button type="button" id="removeHotDealPhoto" class="text-red-600 hover:text-red-800 hidden">
                                        <i class="fas fa-times mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Make <span class="text-red-500">*</span></label>
                                    <input type="text" id="hotDealMake" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. Toyota" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Model <span class="text-red-500">*</span></label>
                                    <input type="text" id="hotDealModel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. Land Cruiser" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Year <span class="text-red-500">*</span></label>
                                    <input type="number" id="hotDealYear" min="2000" max="2024" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. 2022" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Color <span class="text-red-500">*</span></label>
                                    <input type="text" id="hotDealColor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. White" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Budget (USD) <span class="text-red-500">*</span></label>
                                    <input type="number" id="hotDealBudget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. 2500000" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Sales Agent <span class="text-red-500">*</span></label>
                                    <select id="hotDealAgent" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                        <option value="">Select Sales Agent</option>
                                        <!-- Sales agents will be dynamically added from sales people -->
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Additional Specs/Notes</label>
                                <textarea id="hotDealNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Engine size, mileage, special features, etc."></textarea>
                            </div>
                            
                            <button type="submit" class="w-full bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i> Add Hot Deal
                                <div id="hotDealSpinner" class="loading-spinner ml-2 hidden"></div>
                            </button>
                        </form>
                    </div>
                    
                    <div id="hotDealsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 card-grid">
                        <!-- Hot deals will be dynamically added here -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-fire text-3xl mb-4 text-red-500"></i>
                            <p>No hot deals yet</p>
                            <p class="text-sm">Add a new hot deal to get started</p>
                        </div>
                    </div>
                </div>
                
                <!-- Deposits Sub-tab -->
                <div id="deposits-tab" class="deals-tab-content hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Deposits</h3>
                            <p class="text-gray-600">Cars with deposits paid</p>
                        </div>
                        <div class="flex space-x-2 mt-4 md:mt-0">
                            <button id="addDepositBtn" class="bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                                <i class="fas fa-plus mr-2"></i> Add Deposit
                            </button>
                            <button id="importFromHotDealsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                                <i class="fas fa-file-import mr-2"></i> Import from Hot Deals
                            </button>
                        </div>
                    </div>
                    
                    <!-- Add Deposit Form -->
                    <div id="addDepositForm" class="bg-white rounded-xl shadow-lg p-6 card mb-8 hidden">
                        <h4 class="text-lg font-bold text-gray-800 mb-6 flex items-center justify-between">
                            <span><i class="fas fa-money-bill-wave mr-2 text-kenya-green-600"></i> Add New Deposit</span>
                            <button id="closeDepositForm" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </h4>
                        
                        <div id="depositError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                        <div id="depositSuccess" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
                        
                        <form id="depositForm" class="space-y-4">
                            <!-- Photo Upload -->
                            <div>
                                <label class="block text-gray-700 mb-2">Car Photo (Optional)</label>
                                <div id="depositPhotoPreview" class="photo-placeholder">
                                    <i class="fas fa-car text-4xl"></i>
                                </div>
                                <div class="photo-actions">
                                    <input type="file" id="depositPhoto" accept="image/*" class="hidden" />
                                    <label for="depositPhoto" class="photo-upload-btn">
                                        <i class="fas fa-camera mr-2"></i> Upload Photo
                                    </label>
                                    <button type="button" id="removeDepositPhoto" class="text-red-600 hover:text-red-800 hidden">
                                        <i class="fas fa-times mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                            
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
        <label class="block text-gray-700 mb-2">Make <span class="text-red-500">*</span></label>
        <input type="text" id="hotDealMake" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. Toyota" required>
    </div>
    <div>
        <label class="block text-gray-700 mb-2">Model <span class="text-red-500">*</span></label>
        <input type="text" id="hotDealModel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. Land Cruiser" required>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
        <label class="block text-gray-700 mb-2">Year <span class="text-red-500">*</span></label>
        <input type="number" id="hotDealYear" min="2000" max="2024" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. 2022" required>
    </div>
    <div>
        <label class="block text-gray-700 mb-2">Color <span class="text-red-500">*</span></label>
        <input type="text" id="hotDealColor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. White" required>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
        <label class="block text-gray-700 mb-2">Budget (KES) <span class="text-gray-500 text-sm">(Optional)</span></label>
        <input type="number" id="hotDealBudget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. 2500000">
    </div>
    <div>
        <label class="block text-gray-700 mb-2">Sales Agent <span class="text-red-500">*</span></label>
        <select id="hotDealAgent" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
            <option value="">Select Sales Agent</option>
            <!-- Sales agents will be dynamically added from sales people -->
        </select>
    </div>
</div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Additional Notes</label>
                                <textarea id="depositNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Deposit details, client info, etc."></textarea>
                            </div>
                            
                            <button type="submit" class="w-full bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i> Add Deposit
                                <div id="depositSpinner" class="loading-spinner ml-2 hidden"></div>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Import from Hot Deals Modal -->
                    <div id="importHotDealsModal" class="fixed inset-0 z-50 hidden">
                        <div class="modal-overlay absolute inset-0"></div>
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full relative slide-in modal-content">
                                <div class="p-6">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Import from Hot Deals</h3>
                                    <p class="text-gray-600 mb-4">Select a hot deal to move to deposits:</p>
                                    
                                    <div id="hotDealsList" class="max-h-60 overflow-y-auto custom-scrollbar mb-4">
                                        <!-- Hot deals will be dynamically added here -->
                                    </div>
                                    
                                    <div class="flex space-x-3 mt-6">
                                        <button id="cancelImport" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition">
                                            Cancel
                                        </button>
                                        <button id="confirmImport" class="flex-1 bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                                            Import Selected
                                            <div id="importSpinner" class="loading-spinner ml-2 hidden"></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="depositsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 card-grid">
                        <!-- Deposits will be dynamically added here -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-money-bill-wave text-3xl mb-4 text-blue-500"></i>
                            <p>No deposits yet</p>
                            <p class="text-sm">Add a deposit or import from hot deals</p>
                        </div>
                    </div>
                </div>
                
                <!-- Finalised Sub-tab -->
                <div id="finalised-tab" class="deals-tab-content hidden fade-in">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Finalised Deals</h3>
                        <p class="text-gray-600">Successfully completed sales</p>
                    </div>
                    
                    <div id="finalisedContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 card-grid">
                        <!-- Finalised deals will be dynamically added here -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-check-double text-3xl mb-4 text-green-500"></i>
                            <p>No finalised deals yet</p>
                            <p class="text-sm">Move deals from deposits to finalised</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Panel Tab -->
            <div id="admin-tab" class="tab-content hidden fade-in">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Admin Panel</h2>
                    <p class="text-gray-600">Manage vehicles and sales personnel</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add Vehicle Form -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-plus-circle mr-3 text-kenya-green-600"></i> Add New Vehicle
                        </h3>
                        
                        <div id="adminError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                        <div id="adminSuccess" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
                        
                        <form id="addCarForm" class="space-y-4">
                            <!-- 7. Photo Upload Section -->
                            <div>
                                <label class="block text-gray-700 mb-2">Car Photo (Optional)</label>
                                <div id="photoPreview" class="photo-placeholder">
                                    <i class="fas fa-car text-4xl"></i>
                                </div>
                                <div class="photo-actions">
                                    <input type="file" id="carPhoto" accept="image/*" class="hidden" />
                                    <label for="carPhoto" class="photo-upload-btn">
                                        <i class="fas fa-camera mr-2"></i> Upload Photo
                                    </label>
                                    <button type="button" id="removePhoto" class="text-red-600 hover:text-red-800 hidden">
                                        <i class="fas fa-times mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Make <span class="text-red-500">*</span></label>
                                    <input type="text" id="carMake" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. Toyota" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Model <span class="text-red-500">*</span></label>
                                    <input type="text" id="carModel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. Land Cruiser" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Year <span class="text-red-500">*</span></label>
                                    <input type="number" id="carYear" min="2000" max="2024" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. 2022" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Color <span class="text-red-500">*</span></label>
                                    <input type="text" id="carColor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. White" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Sales Person <span class="text-red-500">*</span></label>
                                <select id="carSalesPerson" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                    <option value="">Select Sales Person</option>
                                    <!-- Sales people will be dynamically added here -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Current Stage <span class="text-red-500">*</span></label>
                                <select id="carStage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                    <option value="Due to ship">Due to ship</option>
                                    <option value="On voyage">On voyage</option>
                                    <option value="On port">On port</option>
                                    <option value="Clearing">Clearing</option>
                                    <option value="Due to carrier">Due to carrier</option>
                                    <option value="On carrier">On carrier</option>
                                    <option value="On transit to Nairobi">On transit to Nairobi</option>
                                    <option value="Arrived to Nairobi">Arrived to Nairobi</option>
                                    <option value="Due for delivery">Due for delivery</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Due for sale in Nairobi">Due for sale in Nairobi</option>
                                    <option value="Picked by client from Mombasa">Picked by client from Mombasa</option>
                                </select>
                            </div>
                            
                            <div id="voyageTypeContainer" class="hidden">
                                <label class="block text-gray-700 mb-2">Voyage Type <span class="text-red-500">*</span></label>
                                <div class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="voyageType" value="RORO" class="mr-2" checked>
                                        <span>RORO</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="voyageType" value="Container" class="mr-2">
                                        <span>Container</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="shipNameContainer" class="hidden">
                                <label class="block text-gray-700 mb-2">Ship Name</label>
                                <input type="text" id="carShipName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. MV Mombasa Express">
                            </div>
                            
                            <!-- 4. No ETA Available Option -->
                            <div>
                                <label class="block text-gray-700 mb-2">Next Destination ETA <span class="text-red-500">*</span></label>
                                <select id="etaType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition mb-2">
                                    <option value="date">Select Date</option>
                                    <option value="none">No ETA Available</option>
                                </select>
                                <input type="date" id="carETA" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Notes (Optional)</label>
                                <textarea id="carNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Additional details about the vehicle"></textarea>
                            </div>
                            
                            <button type="submit" class="w-full bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i> Add Vehicle
                                <div id="addCarSpinner" class="loading-spinner ml-2 hidden"></div>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Manage Sales People & Edit Form -->
                    <div>
                        <!-- Manage Sales People -->
                        <div class="bg-white rounded-xl shadow-lg p-6 card mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                <i class="fas fa-users mr-3 text-kenya-green-600"></i> Manage Sales People
                            </h3>
                            
                            <div class="mb-6">
                                <div class="flex space-x-2">
                                    <input type="text" id="salesPersonName" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Sales person name">
                                    <button id="addSalesPersonBtn" class="bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-3 px-4 rounded-lg transition">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="text-left p-3 text-gray-700">Name</th>
                                            <th class="text-left p-3 text-gray-700">Assigned Vehicles</th>
                                            <th class="text-left p-3 text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesPeopleList">
                                        <!-- Sales people will be dynamically added here -->
                                        <tr>
                                            <td colspan="3" class="p-4 text-center text-gray-500">No sales people added yet</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 3. Edit Car Form -->
                        <div id="editCarFormContainer" class="edit-form-container bg-white rounded-xl shadow-lg p-6 card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center justify-between">
                                <span><i class="fas fa-edit mr-3 text-kenya-green-600"></i> Edit Vehicle</span>
                                <button id="closeEditForm" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </h3>
                            
                            <form id="editCarForm" class="space-y-4">
                                <!-- Photo Upload for Edit -->
                                <div>
                                    <label class="block text-gray-700 mb-2">Car Photo</label>
                                    <div id="editPhotoPreview" class="photo-placeholder">
                                        <i class="fas fa-car text-4xl"></i>
                                    </div>
                                    <div class="photo-actions">
                                        <input type="file" id="editCarPhoto" accept="image/*" class="hidden" />
                                        <label for="editCarPhoto" class="photo-upload-btn">
                                            <i class="fas fa-camera mr-2"></i> Change Photo
                                        </label>
                                        <button type="button" id="removeEditPhoto" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-times mr-1"></i> Remove
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Make <span class="text-red-500">*</span></label>
                                        <input type="text" id="editCarMake" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Model <span class="text-red-500">*</span></label>
                                        <input type="text" id="editCarModel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Year <span class="text-red-500">*</span></label>
                                        <input type="number" id="editCarYear" min="2000" max="2024" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Color <span class="text-red-500">*</span></label>
                                        <input type="text" id="editCarColor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Sales Person <span class="text-red-500">*</span></label>
                                    <select id="editCarSalesPerson" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                        <option value="">Select Sales Person</option>
                                        <!-- Sales people will be dynamically added here -->
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Current Stage <span class="text-red-500">*</span></label>
                                    <select id="editCarStage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" required>
                                        <option value="Due to ship">Due to ship</option>
                                        <option value="On voyage">On voyage</option>
                                        <option value="On port">On port</option>
                                        <option value="Clearing">Clearing</option>
                                        <option value="Due to carrier">Due to carrier</option>
                                        <option value="On carrier">On carrier</option>
                                        <option value="On transit to Nairobi">On transit to Nairobi</option>
                                        <option value="Arrived to Nairobi">Arrived to Nairobi</option>
                                        <option value="Due for delivery">Due for delivery</option>
                                        <option value="Delivered">Delivered</option>
                                        <option value="Due for sale in Nairobi">Due for sale in Nairobi</option>
                                        <option value="Picked by client from Mombasa">Picked by client from Mombasa</option>
                                    </select>
                                </div>
                                
                                <div id="editVoyageTypeContainer" class="hidden">
                                    <label class="block text-gray-700 mb-2">Voyage Type <span class="text-red-500">*</span></label>
                                    <div class="flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="editVoyageType" value="RORO" class="mr-2" checked>
                                            <span>RORO</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="editVoyageType" value="Container" class="mr-2">
                                            <span>Container</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="editShipNameContainer" class="hidden">
                                    <label class="block text-gray-700 mb-2">Ship Name</label>
                                    <input type="text" id="editCarShipName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="e.g. MV Mombasa Express">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Next Destination ETA <span class="text-red-500">*</span></label>
                                    <select id="editEtaType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition mb-2">
                                        <option value="date">Select Date</option>
                                        <option value="none">No ETA Available</option>
                                    </select>
                                    <input type="date" id="editCarETA" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Notes (Optional)</label>
                                    <textarea id="editCarNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Additional details about the vehicle"></textarea>
                                </div>
                                
                                <button type="submit" class="w-full bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                                    <i class="fas fa-save mr-2"></i> Save Changes
                                    <div id="editCarSpinner" class="loading-spinner ml-2 hidden"></div>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Manage Existing Vehicles -->
                        <div class="bg-white rounded-xl shadow-lg p-6 card mt-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                <i class="fas fa-edit mr-3 text-kenya-green-600"></i> Manage Existing Vehicles
                            </h3>
                            
                            <div class="overflow-y-auto max-h-80 custom-scrollbar">
                                <div id="manageCarsList" class="space-y-4">
                                    <!-- Existing vehicles will be dynamically added here -->
                                    <div class="text-center py-4 text-gray-500">
                                        Loading vehicles...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Update Stage Modal -->
    <div id="updateStageModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full relative slide-in modal-content">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Update Vehicle Stage</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Select New Stage</label>
                            <select id="newStageSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition">
                                <option value="Due to ship">Due to ship</option>
                                <option value="On voyage">On voyage</option>
                                <option value="On port">On port</option>
                                <option value="Clearing">Clearing</option>
                                <option value="Due to carrier">Due to carrier</option>
                                <option value="On carrier">On carrier</option>
                                <option value="On transit to Nairobi">On transit to Nairobi</option>
                                <option value="Arrived to Nairobi">Arrived to Nairobi</option>
                                <option value="Due for delivery">Due for delivery</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Due for sale in Nairobi">Due for sale in Nairobi</option>
                                <option value="Picked by client from Mombasa">Picked by client from Mombasa</option>
                            </select>
                        </div>
                        <div id="voyageTypeModalContainer" class="hidden">
                            <label class="block text-gray-700 mb-2">Voyage Type</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="voyageTypeModal" value="RORO" class="mr-2" checked>
                                    <span>RORO</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="voyageTypeModal" value="Container" class="mr-2">
                                    <span>Container</span>
                                </label>
                            </div>
                        </div>
                        <div id="shipNameModalContainer" class="hidden">
                            <label class="block text-gray-700 mb-2">Ship Name</label>
                            <input type="text" id="newShipName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition" placeholder="Enter ship name if known">
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button id="cancelUpdateStage" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition">
                            Cancel
                        </button>
                        <button id="confirmUpdateStage" class="flex-1 bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                            Update Stage
                            <div id="updateStageSpinner" class="loading-spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update ETA Modal -->
    <div id="updateETAModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full relative slide-in modal-content">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Update ETA</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">New ETA Date</label>
                            <input type="date" id="newETADate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kenya-green-500 focus:border-kenya-green-500 outline-none transition">
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button id="cancelUpdateETA" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition">
                            Cancel
                        </button>
                        <button id="confirmUpdateETA" class="flex-1 bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                            Update ETA
                            <div id="updateETASpinner" class="loading-spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full relative slide-in modal-content">
                <div class="p-6 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Confirm Delete</h3>
                    <p class="text-gray-600 mb-6" id="deleteMessage">Are you sure you want to delete this item?</p>
                    <div class="flex space-x-3">
                        <button id="cancelDelete" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition">
                            Cancel
                        </button>
                        <button id="confirmDelete" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                            Delete
                            <div id="deleteSpinner" class="loading-spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration and App Logic -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCuUKCxYx0jYKqWOQaN82K5zFGlQsKQsK0",
            authDomain: "ck-manager-1abdc.firebaseapp.com",
            projectId: "ck-manager-1abdc",
            storageBucket: "ck-manager-1abdc.firebasestorage.app",
            messagingSenderId: "890017473158",
            appId: "1:890017473158:web:528e1eebc4b67bd54ca707",
            measurementId: "G-7Z71W1NSX4"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Enable offline persistence
        db.enablePersistence().catch((err) => {
            console.warn('Firebase persistence failed:', err.code);
        });
        
        // Global variables
        let currentUser = null;
        let allCars = [];
        let salesPeople = [];
        let hotDeals = [];
        let deposits = [];
        let finalisedDeals = [];
        let currentCarIdForUpdate = null;
        let currentCarIdForETA = null;
        let currentItemIdForDelete = null;
        let currentDeleteType = null;
        let editCarId = null;
        let carPhotoFile = null;
        let editCarPhotoFile = null;
        let hotDealPhotoFile = null;
        let depositPhotoFile = null;
        let currentDealsTab = 'hot-deals';
        let selectedHotDealForImport = null;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const loginSpinner = document.getElementById('loginSpinner');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const allCarsContainer = document.getElementById('allCarsContainer');
        const successfulDeliveriesContainer = document.getElementById('successfulDeliveriesContainer');
        const searchInput = document.getElementById('searchInput');
        const filterStage = document.getElementById('filterStage');
        const addCarForm = document.getElementById('addCarForm');
        const carStage = document.getElementById('carStage');
        const voyageTypeContainer = document.getElementById('voyageTypeContainer');
        const shipNameContainer = document.getElementById('shipNameContainer');
        const carSalesPerson = document.getElementById('carSalesPerson');
        const addSalesPersonBtn = document.getElementById('addSalesPersonBtn');
        const salesPersonName = document.getElementById('salesPersonName');
        const salesPeopleList = document.getElementById('salesPeopleList');
        const manageCarsList = document.getElementById('manageCarsList');
        const adminError = document.getElementById('adminError');
        const adminSuccess = document.getElementById('adminSuccess');
        const addCarSpinner = document.getElementById('addCarSpinner');
        
        // Photo upload elements
        const carPhotoInput = document.getElementById('carPhoto');
        const photoPreview = document.getElementById('photoPreview');
        const removePhotoBtn = document.getElementById('removePhoto');
        const editCarPhotoInput = document.getElementById('editCarPhoto');
        const editPhotoPreview = document.getElementById('editPhotoPreview');
        const removeEditPhotoBtn = document.getElementById('removeEditPhoto');
        
        // ETA elements
        const etaType = document.getElementById('etaType');
        const carETA = document.getElementById('carETA');
        const editEtaType = document.getElementById('editEtaType');
        const editCarETA = document.getElementById('editCarETA');
        
        // Edit form elements
        const editCarFormContainer = document.getElementById('editCarFormContainer');
        const closeEditForm = document.getElementById('closeEditForm');
        const editCarForm = document.getElementById('editCarForm');
        const editCarSpinner = document.getElementById('editCarSpinner');
        
        // Modal elements
        const updateStageModal = document.getElementById('updateStageModal');
        const updateETAModal = document.getElementById('updateETAModal');
        const deleteModal = document.getElementById('deleteModal');
        const newStageSelect = document.getElementById('newStageSelect');
        const voyageTypeModalContainer = document.getElementById('voyageTypeModalContainer');
        const shipNameModalContainer = document.getElementById('shipNameModalContainer');
        const newETADate = document.getElementById('newETADate');
        const deleteMessage = document.getElementById('deleteMessage');
        
        // Deals elements
        const dealsTabs = document.querySelectorAll('.deals-tab-btn');
        const dealsTabContents = document.querySelectorAll('.deals-tab-content');
        const addHotDealBtn = document.getElementById('addHotDealBtn');
        const addHotDealForm = document.getElementById('addHotDealForm');
        const closeHotDealForm = document.getElementById('closeHotDealForm');
        const hotDealForm = document.getElementById('hotDealForm');
        const hotDealsContainer = document.getElementById('hotDealsContainer');
        const hotDealError = document.getElementById('hotDealError');
        const hotDealSuccess = document.getElementById('hotDealSuccess');
        const hotDealSpinner = document.getElementById('hotDealSpinner');
        const hotDealPhotoInput = document.getElementById('hotDealPhoto');
        const hotDealPhotoPreview = document.getElementById('hotDealPhotoPreview');
        const removeHotDealPhotoBtn = document.getElementById('removeHotDealPhoto');
        
        const addDepositBtn = document.getElementById('addDepositBtn');
        const addDepositForm = document.getElementById('addDepositForm');
        const closeDepositForm = document.getElementById('closeDepositForm');
        const depositForm = document.getElementById('depositForm');
        const depositsContainer = document.getElementById('depositsContainer');
        const depositError = document.getElementById('depositError');
        const depositSuccess = document.getElementById('depositSuccess');
        const depositSpinner = document.getElementById('depositSpinner');
        const depositPhotoInput = document.getElementById('depositPhoto');
        const depositPhotoPreview = document.getElementById('depositPhotoPreview');
        const removeDepositPhotoBtn = document.getElementById('removeDepositPhoto');
        const importFromHotDealsBtn = document.getElementById('importFromHotDealsBtn');
        const importHotDealsModal = document.getElementById('importHotDealsModal');
        const hotDealsList = document.getElementById('hotDealsList');
        const cancelImport = document.getElementById('cancelImport');
        const confirmImport = document.getElementById('confirmImport');
        const importSpinner = document.getElementById('importSpinner');
        const finalisedContainer = document.getElementById('finalisedContainer');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default ETA to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('carETA').valueAsDate = tomorrow;
            newETADate.valueAsDate = new Date();
            
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    showDashboard();
                    loadSalesPeople();
                    loadCars();
                    loadDeals();
                } else {
                    // No user is signed in
                    showLoginScreen();
                }
            });
            
            // Login button event
            loginBtn.addEventListener('click', login);
            
            // Logout button event
            logoutBtn.addEventListener('click', logout);
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Deals tab switching
            dealsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-deals-tab');
                    switchDealsTab(tabId);
                });
            });
            
            // Show/hide voyage type based on stage selection
            carStage.addEventListener('change', function() {
                if (this.value === 'On voyage') {
                    voyageTypeContainer.classList.remove('hidden');
                    shipNameContainer.classList.remove('hidden');
                } else {
                    voyageTypeContainer.classList.add('hidden');
                    shipNameContainer.classList.add('hidden');
                }
            });
            
            // Show/hide voyage type in modal
            newStageSelect.addEventListener('change', function() {
                if (this.value === 'On voyage') {
                    voyageTypeModalContainer.classList.remove('hidden');
                    shipNameModalContainer.classList.remove('hidden');
                } else {
                    voyageTypeModalContainer.classList.add('hidden');
                    shipNameModalContainer.classList.add('hidden');
                }
            });
            
            // Add car form submission
            addCarForm.addEventListener('submit', addNewCar);
            
            // Add sales person
            addSalesPersonBtn.addEventListener('click', addSalesPerson);
            
            // Search functionality
            searchInput.addEventListener('input', filterCars);
            filterStage.addEventListener('change', filterCars);
            
            // Photo upload functionality
            carPhotoInput.addEventListener('change', handlePhotoUpload);
            removePhotoBtn.addEventListener('click', removePhoto);
            editCarPhotoInput.addEventListener('change', handleEditPhotoUpload);
            removeEditPhotoBtn.addEventListener('click', removeEditPhoto);
            
            // ETA type selection
            etaType.addEventListener('change', function() {
                if (this.value === 'none') {
                    carETA.value = '';
                    carETA.disabled = true;
                    carETA.required = false;
                } else {
                    carETA.disabled = false;
                    carETA.required = true;
                    if (!carETA.value) {
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        carETA.valueAsDate = tomorrow;
                    }
                }
            });
            
            editEtaType.addEventListener('change', function() {
                if (this.value === 'none') {
                    editCarETA.value = '';
                    editCarETA.disabled = true;
                    editCarETA.required = false;
                } else {
                    editCarETA.disabled = false;
                    editCarETA.required = true;
                }
            });
            
            // Edit form handling
            closeEditForm.addEventListener('click', function() {
                editCarFormContainer.classList.remove('expanded');
                editCarId = null;
                editCarPhotoFile = null;
            });
            
            editCarForm.addEventListener('submit', editCarSubmit);
            
            // Edit car stage change
            document.getElementById('editCarStage').addEventListener('change', function() {
                if (this.value === 'On voyage') {
                    document.getElementById('editVoyageTypeContainer').classList.remove('hidden');
                    document.getElementById('editShipNameContainer').classList.remove('hidden');
                } else {
                    document.getElementById('editVoyageTypeContainer').classList.add('hidden');
                    document.getElementById('editShipNameContainer').classList.add('hidden');
                }
            });
            
            // Allow Enter key to login
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Modal event handlers
            document.getElementById('cancelUpdateStage').addEventListener('click', () => {
                updateStageModal.classList.add('hidden');
                currentCarIdForUpdate = null;
            });
            
            document.getElementById('confirmUpdateStage').addEventListener('click', updateCarStage);
            
            document.getElementById('cancelUpdateETA').addEventListener('click', () => {
                updateETAModal.classList.add('hidden');
                currentCarIdForETA = null;
            });
            
            document.getElementById('confirmUpdateETA').addEventListener('click', updateCarETA);
            
            document.getElementById('cancelDelete').addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                currentItemIdForDelete = null;
                currentDeleteType = null;
            });
            
            document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
            
            // Initialize stage filters
            initializeStageFilters();
            
            // Deals functionality
            addHotDealBtn.addEventListener('click', () => {
                addHotDealForm.classList.toggle('hidden');
            });
            
            closeHotDealForm.addEventListener('click', () => {
                addHotDealForm.classList.add('hidden');
            });
            
            hotDealForm.addEventListener('submit', addHotDeal);
            
            hotDealPhotoInput.addEventListener('change', handleHotDealPhotoUpload);
            removeHotDealPhotoBtn.addEventListener('click', removeHotDealPhoto);
            
            addDepositBtn.addEventListener('click', () => {
                addDepositForm.classList.toggle('hidden');
            });
            
            closeDepositForm.addEventListener('click', () => {
                addDepositForm.classList.add('hidden');
            });
            
            depositForm.addEventListener('submit', addDeposit);
            
            depositPhotoInput.addEventListener('change', handleDepositPhotoUpload);
            removeDepositPhotoBtn.addEventListener('click', removeDepositPhoto);
            
            importFromHotDealsBtn.addEventListener('click', showImportHotDealsModal);
            cancelImport.addEventListener('click', () => {
                importHotDealsModal.classList.add('hidden');
            });
            
            confirmImport.addEventListener('click', importHotDealToDeposits);
        });
        
        // Show login screen
        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }
        
        // Show dashboard
        function showDashboard() {
            loginScreen.classList.add('hidden');
            dashboard.classList.remove('hidden');
            
            // Set user info
            userName.textContent = currentUser.displayName || 'Admin User';
            userEmail.textContent = currentUser.email;
            userInfo.classList.remove('hidden');
            
            // Switch to all cars tab by default
            switchTab('all-cars');
        }
        
        // Login function with Firebase Authentication
        async function login() {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            // Validation
            if (!email || !password) {
                showLoginError('Please enter both email and password');
                return;
            }
            
            // Show loading spinner
            loginBtn.disabled = true;
            loginSpinner.classList.remove('hidden');
            
            try {
                // Sign in with Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Check if user document exists, create if not
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    // Create user document
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        displayName: 'Admin User',
                        role: 'admin',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showDashboard();
                loadSalesPeople();
                loadCars();
                loadDeals();
                
            } catch (error) {
                console.error('Login error:', error);
                
                // For demo purposes, create a user if not exists
                if (error.code === 'auth/user-not-found' && email === 'admin@carskenya.com') {
                    try {
                        // Create user
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        currentUser = userCredential.user;
                        
                        // Create user document
                        await db.collection('users').doc(currentUser.uid).set({
                            email: currentUser.email,
                            displayName: 'Admin User',
                            role: 'admin',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Add default sales people
                        await addDefaultSalesPeople();
                        
                        showDashboard();
                        loadSalesPeople();
                        loadCars();
                        loadDeals();
                    } catch (createError) {
                        showLoginError(createError.message);
                    }
                } else {
                    showLoginError(error.message);
                }
            } finally {
                // Hide loading spinner
                loginBtn.disabled = false;
                loginSpinner.classList.add('hidden');
            }
        }
        
        // Add default sales people for new users
        async function addDefaultSalesPeople() {
            const defaultSalesPeople = [
                { name: 'John Kamau', vehicleCount: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() },
                { name: 'Mary Wanjiku', vehicleCount: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() },
                { name: 'Peter Omondi', vehicleCount: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            ];
            
            for (const person of defaultSalesPeople) {
                await db.collection('salesPeople').add(person);
            }
        }
        
        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                showLoginScreen();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Show login error
        function showLoginError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                loginError.classList.add('hidden');
            }, 5000);
        }
        
        // Switch between tabs
        function switchTab(tabId) {
            // Update active tab button
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            
            // Show active tab content
            tabContents.forEach(tabContent => {
                if (tabContent.id === `${tabId}-tab`) {
                    tabContent.classList.remove('hidden');
                    tabContent.classList.add('fade-in');
                } else {
                    tabContent.classList.add('hidden');
                    tabContent.classList.remove('fade-in');
                }
            });
            
            // Load data for the tab if needed
            if (tabId === 'successful-deliveries') {
                displaySuccessfulDeliveries();
            } else if (tabId === 'admin') {
                displayManageCars();
            } else if (tabId === 'deals') {
                // Make sure deals tab is visible
                switchDealsTab('hot-deals');
            }
        }
        
        // Switch between deals tabs
        function switchDealsTab(tabId) {
            currentDealsTab = tabId;
            
            // Update active deals tab button
            dealsTabs.forEach(tab => {
                if (tab.getAttribute('data-deals-tab') === tabId) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            
            // Show active deals tab content
            dealsTabContents.forEach(tabContent => {
                if (tabContent.id === `${tabId}-tab`) {
                    tabContent.classList.remove('hidden');
                    tabContent.classList.add('fade-in');
                } else {
                    tabContent.classList.add('hidden');
                    tabContent.classList.remove('fade-in');
                }
            });
            
            // Update sales agent dropdowns
            updateDealsSalesAgentDropdowns();
        }
        
        // Load sales people from Firestore
        async function loadSalesPeople() {
            try {
                const querySnapshot = await db.collection('salesPeople')
                    .orderBy('name')
                    .get();
                
                salesPeople = [];
                querySnapshot.forEach((doc) => {
                    salesPeople.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateSalesPeopleUI();
                updateDealsSalesAgentDropdowns();
            } catch (error) {
                console.error('Error loading sales people:', error);
                showAdminError('Failed to load sales people');
            }
        }
        
        // Update sales people dropdown and list
        function updateSalesPeopleUI() {
            // Update dropdown in add car form
            carSalesPerson.innerHTML = '<option value="">Select Sales Person</option>';
            salesPeople.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                carSalesPerson.appendChild(option);
            });
            
            // Update dropdown in edit car form
            const editCarSalesPerson = document.getElementById('editCarSalesPerson');
            editCarSalesPerson.innerHTML = '<option value="">Select Sales Person</option>';
            salesPeople.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                editCarSalesPerson.appendChild(option);
            });
            
            // Update sales people list in admin panel
            salesPeopleList.innerHTML = '';
            
            if (salesPeople.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="3" class="p-4 text-center text-gray-500">No sales people added yet</td>
                `;
                salesPeopleList.appendChild(row);
                return;
            }
            
            salesPeople.forEach(person => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${person.name}</td>
                    <td class="p-3">
                        <span class="bg-kenya-green-100 text-kenya-green-800 text-xs font-medium px-2.5 py-0.5 rounded">${person.vehicleCount || 0} vehicles</span>
                    </td>
                    <td class="p-3">
                        <button class="text-red-600 hover:text-red-800 delete-sales-person" data-id="${person.id}" data-name="${person.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                salesPeopleList.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-sales-person').forEach(button => {
                button.addEventListener('click', function() {
                    const personId = this.getAttribute('data-id');
                    const personName = this.getAttribute('data-name');
                    showDeleteModal('salesPerson', personId, `sales person "${personName}"`);
                });
            });
        }
        
        // Update sales agent dropdowns in deals forms
        function updateDealsSalesAgentDropdowns() {
            const hotDealAgent = document.getElementById('hotDealAgent');
            const depositAgent = document.getElementById('depositAgent');
            
            if (hotDealAgent) {
                hotDealAgent.innerHTML = '<option value="">Select Sales Agent</option>';
                salesPeople.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = person.name;
                    hotDealAgent.appendChild(option);
                });
            }
            
            if (depositAgent) {
                depositAgent.innerHTML = '<option value="">Select Sales Agent</option>';
                salesPeople.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = person.name;
                    depositAgent.appendChild(option);
                });
            }
        }
        
        // Add a new sales person
        async function addSalesPerson() {
            const name = salesPersonName.value.trim();
            
            if (!name) {
                showAdminError('Please enter a name for the sales person');
                return;
            }
            
            // Check if sales person already exists
            if (salesPeople.some(person => person.name === name)) {
                showAdminError('Sales person with this name already exists');
                return;
            }
            
            try {
                const docRef = await db.collection('salesPeople').add({
                    name: name,
                    vehicleCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                salesPersonName.value = '';
                await loadSalesPeople(); // Reload the list
                showAdminSuccess(`Sales person "${name}" added successfully`);
            } catch (error) {
                console.error('Error adding sales person:', error);
                showAdminError('Error adding sales person: ' + error.message);
            }
        }
        
        // Load cars from Firestore
        async function loadCars() {
            try {
                const querySnapshot = await db.collection('cars')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allCars = [];
                querySnapshot.forEach((doc) => {
                    const carData = doc.data();
                    // Convert Firestore timestamp to Date if needed
                    if (carData.createdAt && carData.createdAt.toDate) {
                        carData.createdAt = carData.createdAt.toDate().toISOString();
                    }
                    
                    allCars.push({
                        id: doc.id,
                        ...carData
                    });
                });
                
                displayAllCars();
                updateSalesPeopleVehicleCounts();
            } catch (error) {
                console.error('Error loading cars:', error);
                showAdminError('Failed to load vehicles');
            }
        }
        
        // Load deals from Firestore
        async function loadDeals() {
            try {
                // Load hot deals
                const hotDealsSnapshot = await db.collection('hotDeals')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                hotDeals = [];
                hotDealsSnapshot.forEach((doc) => {
                    const dealData = doc.data();
                    if (dealData.createdAt && dealData.createdAt.toDate) {
                        dealData.createdAt = dealData.createdAt.toDate().toISOString();
                    }
                    
                    hotDeals.push({
                        id: doc.id,
                        ...dealData
                    });
                });
                
                // Load deposits
                const depositsSnapshot = await db.collection('deposits')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                deposits = [];
                depositsSnapshot.forEach((doc) => {
                    const depositData = doc.data();
                    if (depositData.createdAt && depositData.createdAt.toDate) {
                        depositData.createdAt = depositData.createdAt.toDate().toISOString();
                    }
                    
                    deposits.push({
                        id: doc.id,
                        ...depositData
                    });
                });
                
                // Load finalised deals
                const finalisedSnapshot = await db.collection('finalisedDeals')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                finalisedDeals = [];
                finalisedSnapshot.forEach((doc) => {
                    const dealData = doc.data();
                    if (dealData.createdAt && dealData.createdAt.toDate) {
                        dealData.createdAt = dealData.createdAt.toDate().toISOString();
                    }
                    
                    finalisedDeals.push({
                        id: doc.id,
                        ...dealData
                    });
                });
                
                displayHotDeals();
                displayDeposits();
                displayFinalisedDeals();
                
            } catch (error) {
                console.error('Error loading deals:', error);
                showHotDealError('Failed to load deals');
            }
        }
        
        // Update vehicle counts for sales people
        async function updateSalesPeopleVehicleCounts() {
            // Reset counts
            salesPeople.forEach(person => {
                person.vehicleCount = 0;
            });
            
            // Count vehicles per sales person
            allCars.forEach(car => {
                const person = salesPeople.find(p => p.id === car.salesPerson);
                if (person) {
                    person.vehicleCount = (person.vehicleCount || 0) + 1;
                }
            });
            
            // Update UI
            updateSalesPeopleUI();
            
            // Update counts in Firestore
            for (const person of salesPeople) {
                try {
                    await db.collection('salesPeople').doc(person.id).update({
                        vehicleCount: person.vehicleCount || 0
                    });
                } catch (error) {
                    console.error('Error updating sales person count:', error);
                }
            }
        }
        
        // Display all cars in the All Cars tab
        function displayAllCars() {
            const loadingElement = document.getElementById('loadingCars');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // Filter cars (excluding delivered ones for the main view)
            const filteredCars = allCars.filter(car => car.stage !== 'Delivered');
            
            if (filteredCars.length === 0) {
                allCarsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-car text-3xl mb-4"></i>
                        <p class="text-lg">No vehicles in transit</p>
                        <p class="text-sm">Add a new vehicle in the Admin Panel</p>
                    </div>
                `;
                return;
            }
            
            allCarsContainer.innerHTML = '';
            
            filteredCars.forEach(car => {
                const card = createCarCard(car);
                allCarsContainer.appendChild(card);
            });
        }
        
        // Display successful deliveries
        function displaySuccessfulDeliveries() {
            const deliveredCars = allCars.filter(car => car.stage === 'Delivered');
            
            if (deliveredCars.length === 0) {
                successfulDeliveriesContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-check-circle text-3xl mb-4 text-kenya-green-600"></i>
                        <p class="text-lg">No successful deliveries yet</p>
                        <p class="text-sm">Delivered vehicles will appear here</p>
                    </div>
                `;
                return;
            }
            
            successfulDeliveriesContainer.innerHTML = '';
            
            deliveredCars.forEach(car => {
                const card = createCarCard(car);
                successfulDeliveriesContainer.appendChild(card);
            });
        }
        
        // Display hot deals
        function displayHotDeals() {
            if (hotDeals.length === 0) {
                hotDealsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-fire text-3xl mb-4 text-red-500"></i>
                        <p class="text-lg">No hot deals yet</p>
                        <p class="text-sm">Add a new hot deal to get started</p>
                    </div>
                `;
                return;
            }
            
            hotDealsContainer.innerHTML = '';
            
            hotDeals.forEach(deal => {
                const card = createHotDealCard(deal);
                hotDealsContainer.appendChild(card);
            });
        }
        
        // Display deposits
        function displayDeposits() {
            if (deposits.length === 0) {
                depositsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-money-bill-wave text-3xl mb-4 text-blue-500"></i>
                        <p class="text-lg">No deposits yet</p>
                        <p class="text-sm">Add a deposit or import from hot deals</p>
                    </div>
                `;
                return;
            }
            
            depositsContainer.innerHTML = '';
            
            deposits.forEach(deposit => {
                const card = createDepositCard(deposit);
                depositsContainer.appendChild(card);
            });
        }
        
        // Display finalised deals
        function displayFinalisedDeals() {
            if (finalisedDeals.length === 0) {
                finalisedContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-check-double text-3xl mb-4 text-green-500"></i>
                        <p class="text-lg">No finalised deals yet</p>
                        <p class="text-sm">Move deals from deposits to finalised</p>
                    </div>
                `;
                return;
            }
            
            finalisedContainer.innerHTML = '';
            
            finalisedDeals.forEach(deal => {
                const card = createFinalisedDealCard(deal);
                finalisedContainer.appendChild(card);
            });
        }
        
        // Display cars in the manage cars section
        function displayManageCars() {
            if (allCars.length === 0) {
                manageCarsList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        No vehicles to manage
                    </div>
                `;
                return;
            }
            
            manageCarsList.innerHTML = '';
            
            allCars.forEach(car => {
                const carElement = document.createElement('div');
                carElement.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                carElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-gray-800">${car.make} ${car.model} (${car.year})</h4>
                            <p class="text-sm text-gray-600">${car.color}  ${salesPeople.find(p => p.id === car.salesPerson)?.name || 'Unknown'}</p>
                            <div class="flex items-center mt-2">
                                <span class="stage-badge ${getStageClass(car.stage)} text-white text-xs font-medium px-2.5 py-0.5 rounded">${car.stage}</span>
                                <span class="ml-2 text-xs text-gray-500">ETA: ${car.eta === 'No ETA Available' ? 'No ETA' : formatDate(car.eta)}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-car text-blue-600 hover:text-blue-800" data-id="${car.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-car text-red-600 hover:text-red-800" data-id="${car.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                manageCarsList.appendChild(carElement);
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-car').forEach(button => {
                button.addEventListener('click', function() {
                    const carId = this.getAttribute('data-id');
                    editCar(carId);
                });
            });
            
            document.querySelectorAll('.delete-car').forEach(button => {
                button.addEventListener('click', function() {
                    const carId = this.getAttribute('data-id');
                    const car = allCars.find(c => c.id === carId);
                    if (car) {
                        showDeleteModal('car', carId, `vehicle ${car.make} ${car.model}`);
                    }
                });
            });
        }
        
        // Create a car card for display
        function createCarCard(car) {
            const card = document.createElement('div');
            card.className = `bg-white rounded-xl shadow-lg overflow-hidden card ${car.stage === 'Delivered' ? 'success-delivery' : ''}`;
            
            // Calculate days until ETA
            const daysUntilETA = car.eta && car.eta !== 'No ETA Available' ? calculateDaysUntilETA(car.eta) : null;
            const salesPerson = salesPeople.find(p => p.id === car.salesPerson);
            const hasLongDescription = car.notes && car.notes.length > 100;
            const truncatedDescription = hasLongDescription ? car.notes.substring(0, 100) + '...' : car.notes;
            
            card.innerHTML = `
                <div class="p-6">
                    <!-- Car Photo -->
                    ${car.photoUrl ? `
                        <img src="${car.photoUrl}" alt="${car.make} ${car.model}" class="car-photo" onerror="this.src='https://via.placeholder.com/300x150/188301/FFFFFF?text=No+Photo'">
                    ` : `
                        <div class="photo-placeholder">
                            <i class="fas fa-car text-3xl"></i>
                        </div>
                    `}
                    
                    <!-- Rest of the car info -->
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${car.make} ${car.model}</h3>
                            <p class="text-gray-600">${car.year}  ${car.color}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-500">Sales Person</div>
                            <div class="font-semibold text-gray-800">${salesPerson?.name || 'Unknown'}</div>
                        </div>
                    </div>
                    
                    <!-- Stage indicator -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Current Stage</span>
                            <span>${getStageIcon(car.stage)}</span>
                        </div>
                        <div class="stage-indicator ${getIndicatorClass(car.stage)} w-full mb-2"></div>
                        <div class="font-bold ${getStageClass(car.stage)} text-xs font-medium px-2.5 py-0.5 rounded inline-block">${car.stage}</div>
                        ${car.voyageType ? `<div class="text-sm text-gray-600 mt-1">Voyage Type: ${car.voyageType}</div>` : ''}
                        ${car.shipName ? `<div class="text-sm text-gray-600 mt-1">Ship: ${car.shipName}</div>` : ''}
                    </div>
                    
                    <!-- ETA Section -->
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-sm font-medium text-gray-500">Next Destination ETA</div>
                            <div class="font-semibold ${daysUntilETA && daysUntilETA <= 3 ? 'text-red-600' : 'text-gray-800'}">
                                ${car.eta === 'No ETA Available' ? 'No ETA Available' : formatDate(car.eta)}
                            </div>
                        </div>
                        ${car.eta !== 'No ETA Available' && daysUntilETA !== null ? `
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-500">Days Remaining</div>
                            <div class="font-bold ${daysUntilETA <= 3 ? 'text-red-600' : daysUntilETA <= 7 ? 'text-yellow-600' : 'text-kenya-green-600'}">
                                ${daysUntilETA} day${daysUntilETA !== 1 ? 's' : ''}
                            </div>
                        </div>` : ''}
                    </div>
                    
                    <!-- Notes Section with Read More and Copy -->
                    ${car.notes ? `
                    <div class="mb-6 p-3 bg-kenya-green-50 rounded-lg border border-kenya-green-100 description-container">
                        <button class="copy-btn" data-text="${car.notes.replace(/"/g, '&quot;')}">
                            <i class="fas fa-copy text-gray-600"></i>
                        </button>
                        <div class="text-sm text-gray-700 truncated-text" id="notes-${car.id}">
                            ${truncatedDescription}
                        </div>
                        ${hasLongDescription ? `
                        <button class="text-kenya-green-600 text-sm font-medium mt-2 read-more-btn" data-id="${car.id}" data-full="${car.notes.replace(/"/g, '&quot;')}">
                            Read More
                        </button>` : ''}
                    </div>` : ''}
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-3">
                        <button class="flex-1 bg-kenya-green-100 hover:bg-kenya-green-200 text-kenya-green-700 font-medium py-2 px-4 rounded-lg transition update-stage" data-id="${car.id}">
                            <i class="fas fa-arrow-right mr-2"></i>Update Stage
                        </button>
                        <button class="flex-1 bg-kenya-green-600 hover:bg-kenya-green-700 text-white font-medium py-2 px-4 rounded-lg transition update-eta" data-id="${car.id}">
                            <i class="fas fa-calendar-alt mr-2"></i>Update ETA
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const updateStageBtn = card.querySelector('.update-stage');
            const updateETABtn = card.querySelector('.update-eta');
            const copyBtn = card.querySelector('.copy-btn');
            const readMoreBtn = card.querySelector('.read-more-btn');
            
            updateStageBtn.addEventListener('click', function() {
                const carId = this.getAttribute('data-id');
                showUpdateStageModal(carId);
            });
            
            updateETABtn.addEventListener('click', function() {
                const carId = this.getAttribute('data-id');
                showUpdateETAModal(carId);
            });
            
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const text = this.getAttribute('data-text');
                    navigator.clipboard.writeText(text).then(() => {
                        showAdminSuccess('Description copied to clipboard!');
                    });
                });
            }
            
            if (readMoreBtn) {
                readMoreBtn.addEventListener('click', function() {
                    const carId = this.getAttribute('data-id');
                    const fullText = this.getAttribute('data-full');
                    const notesElement = document.getElementById(`notes-${carId}`);
                    
                    if (this.textContent === 'Read More') {
                        notesElement.textContent = fullText;
                        notesElement.classList.remove('truncated-text');
                        notesElement.classList.add('full-text');
                        this.textContent = 'Read Less';
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        const truncated = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                        notesElement.textContent = truncated;
                        notesElement.classList.add('truncated-text');
                        notesElement.classList.remove('full-text');
                        this.textContent = 'Read More';
                    }
                });
            }
            
            return card;
        }
        
      // Create a hot deal card
function createHotDealCard(deal) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-lg overflow-hidden card';
    
    const salesAgent = salesPeople.find(p => p.id === deal.salesAgent);
    const hasLongDescription = deal.notes && deal.notes.length > 100;
    const truncatedDescription = hasLongDescription ? deal.notes.substring(0, 100) + '...' : deal.notes;
    
    card.innerHTML = `
        <div class="p-6">
            <!-- Car Photo -->
            ${deal.photoUrl ? `
                <img src="${deal.photoUrl}" alt="${deal.make} ${deal.model}" class="car-photo" onerror="this.src='https://via.placeholder.com/300x150/188301/FFFFFF?text=No+Photo'">
            ` : `
                <div class="photo-placeholder">
                    <i class="fas fa-car text-3xl"></i>
                </div>
            `}
            
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${deal.make} ${deal.model}</h3>
                    <p class="text-gray-600">${deal.year}  ${deal.color}</p>
                </div>
                <div class="text-right">
                    <div class="text-sm font-medium text-gray-500">Sales Agent</div>
                    <div class="font-semibold text-gray-800">${salesAgent?.name || 'Unknown'}</div>
                </div>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Status</span>
                    <span><i class="fas fa-fire text-red-500"></i></span>
                </div>
                <div class="stage-indicator indicator-hot w-full mb-2"></div>
                <div class="font-bold deal-hot text-xs font-medium px-2.5 py-0.5 rounded inline-block">Hot Deal</div>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <div>
                    <div class="text-sm font-medium text-gray-500">Budget</div>
                    <div class="font-semibold text-gray-800">${deal.budget ? `KES ${formatNumber(deal.budget)}` : 'Not specified'}</div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-medium text-gray-500">Date Added</div>
                    <div class="font-semibold text-gray-800">${deal.createdAt ? formatDate(deal.createdAt) : 'N/A'}</div>
                </div>
            </div>
            
            ${deal.notes ? `
            <div class="mb-6 p-3 bg-red-50 rounded-lg border border-red-100 description-container">
                <button class="copy-btn" data-text="${deal.notes.replace(/"/g, '&quot;')}">
                    <i class="fas fa-copy text-gray-600"></i>
                </button>
                <div class="text-sm text-gray-700 truncated-text" id="hotdeal-notes-${deal.id}">
                    ${truncatedDescription}
                </div>
                ${hasLongDescription ? `
                <button class="text-red-600 text-sm font-medium mt-2 read-more-btn" data-id="${deal.id}" data-type="hotdeal" data-full="${deal.notes.replace(/"/g, '&quot;')}">
                    Read More
                </button>` : ''}
            </div>` : ''}
            
            <div class="flex space-x-3">
                <button class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition move-to-deposit" data-id="${deal.id}">
                    <i class="fas fa-money-bill-wave mr-2"></i>Move to Deposits
                </button>
                <button class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition delete-hot-deal" data-id="${deal.id}">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
            </div>
        </div>
    `;
    
    // Add event listeners
    const moveToDepositBtn = card.querySelector('.move-to-deposit');
    const deleteBtn = card.querySelector('.delete-hot-deal');
    const copyBtn = card.querySelector('.copy-btn');
    const readMoreBtn = card.querySelector('.read-more-btn');
    
    moveToDepositBtn.addEventListener('click', function() {
        const dealId = this.getAttribute('data-id');
        moveHotDealToDeposits(dealId);
    });
    
    deleteBtn.addEventListener('click', function() {
        const dealId = this.getAttribute('data-id');
        const deal = hotDeals.find(d => d.id === dealId);
        if (deal) {
            showDeleteModal('hotDeal', dealId, `hot deal ${deal.make} ${deal.model}`);
        }
    });
    
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const text = this.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => {
                showHotDealSuccess('Description copied to clipboard!');
            });
        });
    }
    
    if (readMoreBtn) {
        readMoreBtn.addEventListener('click', function() {
            const dealId = this.getAttribute('data-id');
            const fullText = this.getAttribute('data-full');
            const notesElement = document.getElementById(`hotdeal-notes-${dealId}`);
            
            if (this.textContent === 'Read More') {
                notesElement.textContent = fullText;
                notesElement.classList.remove('truncated-text');
                notesElement.classList.add('full-text');
                this.textContent = 'Read Less';
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                const truncated = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                notesElement.textContent = truncated;
                notesElement.classList.add('truncated-text');
                notesElement.classList.remove('full-text');
                this.textContent = 'Read More';
            }
        });
    }
    
    return card;
}
        
        // Create a deposit card
        function createDepositCard(deposit) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden card';
            
            const salesAgent = salesPeople.find(p => p.id === deposit.salesAgent);
            const hasLongDescription = deposit.notes && deposit.notes.length > 100;
            const truncatedDescription = hasLongDescription ? deposit.notes.substring(0, 100) + '...' : deposit.notes;
            
            card.innerHTML = `
                <div class="p-6">
                    <!-- Car Photo -->
                    ${deposit.photoUrl ? `
                        <img src="${deposit.photoUrl}" alt="${deposit.make} ${deposit.model}" class="car-photo" onerror="this.src='https://via.placeholder.com/300x150/188301/FFFFFF?text=No+Photo'">
                    ` : `
                        <div class="photo-placeholder">
                            <i class="fas fa-car text-3xl"></i>
                        </div>
                    `}
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${deposit.make} ${deposit.model}</h3>
                            <p class="text-gray-600">${deposit.year}  ${deposit.color}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-500">Sales Agent</div>
                            <div class="font-semibold text-gray-800">${salesAgent?.name || 'Unknown'}</div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Status</span>
                            <span><i class="fas fa-money-bill-wave text-blue-500"></i></span>
                        </div>
                        <div class="stage-indicator indicator-deposit w-full mb-2"></div>
                        <div class="font-bold deal-deposit text-xs font-medium px-2.5 py-0.5 rounded inline-block">Deposit Paid</div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-sm font-medium text-gray-500">Deposit Amount</div>
                            <div class="font-semibold text-gray-800">KES ${formatNumber(deposit.amount)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-500">Date Added</div>
                            <div class="font-semibold text-gray-800">${deposit.createdAt ? formatDate(deposit.createdAt) : 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${deposit.notes ? `
                    <div class="mb-6 p-3 bg-blue-50 rounded-lg border border-blue-100 description-container">
                        <button class="copy-btn" data-text="${deposit.notes.replace(/"/g, '&quot;')}">
                            <i class="fas fa-copy text-gray-600"></i>
                        </button>
                        <div class="text-sm text-gray-700 truncated-text" id="deposit-notes-${deposit.id}">
                            ${truncatedDescription}
                        </div>
                        ${hasLongDescription ? `
                        <button class="text-blue-600 text-sm font-medium mt-2 read-more-btn" data-id="${deposit.id}" data-type="deposit" data-full="${deposit.notes.replace(/"/g, '&quot;')}">
                            Read More
                        </button>` : ''}
                    </div>` : ''}
                    
                    <div class="flex space-x-3">
                        <button class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition move-to-finalised" data-id="${deposit.id}">
                            <i class="fas fa-check-double mr-2"></i>Finalise Deal
                        </button>
                        <button class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition delete-deposit" data-id="${deposit.id}">
                            <i class="fas fa-trash mr-2"></i>Delete
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const moveToFinalisedBtn = card.querySelector('.move-to-finalised');
            const deleteBtn = card.querySelector('.delete-deposit');
            const copyBtn = card.querySelector('.copy-btn');
            const readMoreBtn = card.querySelector('.read-more-btn');
            
            moveToFinalisedBtn.addEventListener('click', function() {
                const depositId = this.getAttribute('data-id');
                moveDepositToFinalised(depositId);
            });
            
            deleteBtn.addEventListener('click', function() {
                const depositId = this.getAttribute('data-id');
                const deposit = deposits.find(d => d.id === depositId);
                if (deposit) {
                    showDeleteModal('deposit', depositId, `deposit ${deposit.make} ${deposit.model}`);
                }
            });
            
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const text = this.getAttribute('data-text');
                    navigator.clipboard.writeText(text).then(() => {
                        showDepositSuccess('Description copied to clipboard!');
                    });
                });
            }
            
            if (readMoreBtn) {
                readMoreBtn.addEventListener('click', function() {
                    const depositId = this.getAttribute('data-id');
                    const fullText = this.getAttribute('data-full');
                    const notesElement = document.getElementById(`deposit-notes-${depositId}`);
                    
                    if (this.textContent === 'Read More') {
                        notesElement.textContent = fullText;
                        notesElement.classList.remove('truncated-text');
                        notesElement.classList.add('full-text');
                        this.textContent = 'Read Less';
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        const truncated = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                        notesElement.textContent = truncated;
                        notesElement.classList.add('truncated-text');
                        notesElement.classList.remove('full-text');
                        this.textContent = 'Read More';
                    }
                });
            }
            
            return card;
        }
        
        // Create a finalised deal card
        function createFinalisedDealCard(deal) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden card success-delivery';
            
            const salesAgent = salesPeople.find(p => p.id === deal.salesAgent);
            const hasLongDescription = deal.notes && deal.notes.length > 100;
            const truncatedDescription = hasLongDescription ? deal.notes.substring(0, 100) + '...' : deal.notes;
            
            // Check if it came from hot deals or deposits
            const cameFromHotDeal = deal.originalHotDealId !== undefined;
            const cameFromDeposit = deal.originalDepositId !== undefined;
            
            card.innerHTML = `
                <div class="p-6">
                    <!-- Car Photo -->
                    ${deal.photoUrl ? `
                        <img src="${deal.photoUrl}" alt="${deal.make} ${deal.model}" class="car-photo" onerror="this.src='https://via.placeholder.com/300x150/188301/FFFFFF?text=No+Photo'">
                    ` : `
                        <div class="photo-placeholder">
                            <i class="fas fa-car text-3xl"></i>
                        </div>
                    `}
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${deal.make} ${deal.model}</h3>
                            <p class="text-gray-600">${deal.year}  ${deal.color}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-500">Sales Agent</div>
                            <div class="font-semibold text-gray-800">${salesAgent?.name || 'Unknown'}</div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Status</span>
                            <span><i class="fas fa-check-double text-green-500"></i></span>
                        </div>
                        <div class="stage-indicator indicator-finalised w-full mb-2"></div>
                        <div class="font-bold deal-finalised text-xs font-medium px-2.5 py-0.5 rounded inline-block">Finalised Deal</div>
                        ${cameFromHotDeal ? `<div class="text-xs text-gray-500 mt-1">Originally from Hot Deals</div>` : ''}
                        ${cameFromDeposit ? `<div class="text-xs text-gray-500 mt-1">Deposit: KES ${formatNumber(deal.depositAmount || 0)}</div>` : ''}
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-sm font-medium text-gray-500">Final Price</div>
                            <div class="font-semibold text-gray-800">${deal.finalPrice ? `KES ${formatNumber(deal.finalPrice)}` : 'Not specified'}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-500">Date Finalised</div>
                            <div class="font-semibold text-gray-800">${deal.finalisedAt ? formatDate(deal.finalisedAt) : (deal.createdAt ? formatDate(deal.createdAt) : 'N/A')}</div>
                        </div>
                    </div>
                    
                    ${deal.notes ? `
                    <div class="mb-6 p-3 bg-green-50 rounded-lg border border-green-100 description-container">
                        <button class="copy-btn" data-text="${deal.notes.replace(/"/g, '&quot;')}">
                            <i class="fas fa-copy text-gray-600"></i>
                        </button>
                        <div class="text-sm text-gray-700 truncated-text" id="finalised-notes-${deal.id}">
                            ${truncatedDescription}
                        </div>
                        ${hasLongDescription ? `
                        <button class="text-green-600 text-sm font-medium mt-2 read-more-btn" data-id="${deal.id}" data-type="finalised" data-full="${deal.notes.replace(/"/g, '&quot;')}">
                            Read More
                        </button>` : ''}
                    </div>` : ''}
                    
                    <div class="flex space-x-3">
                        <button class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition delete-finalised" data-id="${deal.id}">
                            <i class="fas fa-trash mr-2"></i>Delete
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const deleteBtn = card.querySelector('.delete-finalised');
            const copyBtn = card.querySelector('.copy-btn');
            const readMoreBtn = card.querySelector('.read-more-btn');
            
            deleteBtn.addEventListener('click', function() {
                const dealId = this.getAttribute('data-id');
                const deal = finalisedDeals.find(d => d.id === dealId);
                if (deal) {
                    showDeleteModal('finalisedDeal', dealId, `finalised deal ${deal.make} ${deal.model}`);
                }
            });
            
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const text = this.getAttribute('data-text');
                    navigator.clipboard.writeText(text).then(() => {
                        showAdminSuccess('Description copied to clipboard!');
                    });
                });
            }
            
            if (readMoreBtn) {
                readMoreBtn.addEventListener('click', function() {
                    const dealId = this.getAttribute('data-id');
                    const fullText = this.getAttribute('data-full');
                    const notesElement = document.getElementById(`finalised-notes-${dealId}`);
                    
                    if (this.textContent === 'Read More') {
                        notesElement.textContent = fullText;
                        notesElement.classList.remove('truncated-text');
                        notesElement.classList.add('full-text');
                        this.textContent = 'Read Less';
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        const truncated = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                        notesElement.textContent = truncated;
                        notesElement.classList.add('truncated-text');
                        notesElement.classList.remove('full-text');
                        this.textContent = 'Read More';
                    }
                });
            }
            
            return card;
        }
        
        // Show update stage modal
        function showUpdateStageModal(carId) {
            const car = allCars.find(c => c.id === carId);
            if (!car) return;
            
            currentCarIdForUpdate = carId;
            newStageSelect.value = car.stage;
            
            // Show/hide voyage type field
            if (car.stage === 'On voyage') {
                voyageTypeModalContainer.classList.remove('hidden');
                shipNameModalContainer.classList.remove('hidden');
                
                // Set current values
                if (car.voyageType) {
                    document.querySelector(`input[name="voyageTypeModal"][value="${car.voyageType}"]`).checked = true;
                }
                if (car.shipName) {
                    document.getElementById('newShipName').value = car.shipName;
                }
            } else {
                voyageTypeModalContainer.classList.add('hidden');
                shipNameModalContainer.classList.add('hidden');
            }
            
            updateStageModal.classList.remove('hidden');
        }
        
        // Show update ETA modal
        function showUpdateETAModal(carId) {
            const car = allCars.find(c => c.id === carId);
            if (!car) return;
            
            currentCarIdForETA = carId;
            if (car.eta && car.eta !== 'No ETA Available') {
                newETADate.value = car.eta;
            } else {
                newETADate.valueAsDate = new Date();
            }
            updateETAModal.classList.remove('hidden');
        }
        
        // Show delete confirmation modal
        function showDeleteModal(type, id, name) {
            currentDeleteType = type;
            currentItemIdForDelete = id;
            deleteMessage.textContent = `Are you sure you want to delete ${name}? This action cannot be undone.`;
            deleteModal.classList.remove('hidden');
        }
        
       // Show import hot deals modal
function showImportHotDealsModal() {
    if (hotDeals.length === 0) {
        showDepositError('No hot deals available to import');
        return;
    }
    
    hotDealsList.innerHTML = '';
    selectedHotDealForImport = null;
    
    hotDeals.forEach(deal => {
        const salesAgent = salesPeople.find(p => p.id === deal.salesAgent);
        const dealItem = document.createElement('div');
        dealItem.className = 'p-3 border border-gray-200 rounded-lg mb-2 cursor-pointer hover:bg-gray-50';
        dealItem.innerHTML = `
            <div class="flex items-center">
                <input type="radio" name="hotDealSelect" value="${deal.id}" class="mr-3" id="hotDeal-${deal.id}">
                <div>
                    <label for="hotDeal-${deal.id}" class="cursor-pointer">
                        <div class="font-medium">${deal.make} ${deal.model} (${deal.year})</div>
                        <div class="text-sm text-gray-600">${deal.color}  Budget: ${deal.budget ? `KES ${formatNumber(deal.budget)}` : 'Not specified'}  Agent: ${salesAgent?.name || 'Unknown'}</div>
                    </label>
                </div>
            </div>
        `;
        
        dealItem.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            selectedHotDealForImport = deal.id;
        });
        
        hotDealsList.appendChild(dealItem);
    });
    
    importHotDealsModal.classList.remove('hidden');
}
        
        // Handle photo upload
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                carPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="photo-preview">`;
                    removePhotoBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Handle edit photo upload
        function handleEditPhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                editCarPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    editPhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="photo-preview">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Handle hot deal photo upload
        function handleHotDealPhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                hotDealPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    hotDealPhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="photo-preview">`;
                    removeHotDealPhotoBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Handle deposit photo upload
        function handleDepositPhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                depositPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    depositPhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="photo-preview">`;
                    removeDepositPhotoBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Remove photo
        function removePhoto() {
            carPhotoInput.value = '';
            carPhotoFile = null;
            photoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
            removePhotoBtn.classList.add('hidden');
        }
        
        // Remove edit photo
        function removeEditPhoto() {
            editCarPhotoInput.value = '';
            editCarPhotoFile = null;
            editPhotoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
        }
        
        // Remove hot deal photo
        function removeHotDealPhoto() {
            hotDealPhotoInput.value = '';
            hotDealPhotoFile = null;
            hotDealPhotoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
            removeHotDealPhotoBtn.classList.add('hidden');
        }
        
        // Remove deposit photo
        function removeDepositPhoto() {
            depositPhotoInput.value = '';
            depositPhotoFile = null;
            depositPhotoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
            removeDepositPhotoBtn.classList.add('hidden');
        }
        
        // Add a new car
        async function addNewCar(e) {
            e.preventDefault();
            
            // Get form values
            const make = document.getElementById('carMake').value.trim();
            const model = document.getElementById('carModel').value.trim();
            const year = parseInt(document.getElementById('carYear').value);
            const color = document.getElementById('carColor').value.trim();
            const salesPersonId = document.getElementById('carSalesPerson').value;
            const stage = document.getElementById('carStage').value;
            const eta = etaType.value === 'none' ? 'No ETA Available' : document.getElementById('carETA').value;
            const notes = document.getElementById('carNotes').value.trim();
            
            // Validate
            if (!make || !model || !year || !color || !salesPersonId || !stage || !eta) {
                showAdminError('Please fill in all required fields');
                return;
            }
            
            if (etaType.value === 'date' && !document.getElementById('carETA').value) {
                showAdminError('Please select an ETA date');
                return;
            }
            
            // Get voyage type if applicable
            let voyageType = null;
            let shipName = null;
            if (stage === 'On voyage') {
                const voyageTypeRadio = document.querySelector('input[name="voyageType"]:checked');
                voyageType = voyageTypeRadio ? voyageTypeRadio.value : null;
                shipName = document.getElementById('carShipName').value.trim();
            }
            
            // Show loading spinner
            const submitBtn = addCarForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            addCarSpinner.classList.remove('hidden');
            
            try {
                // Upload photo if exists
                let photoUrl = null;
                if (carPhotoFile) {
                    const fileName = `car_photos/${Date.now()}_${carPhotoFile.name}`;
                    const storageRef = storage.ref(fileName);
                    const snapshot = await storageRef.put(carPhotoFile);
                    photoUrl = await snapshot.ref.getDownloadURL();
                }
                
                // Create car object
                const newCar = {
                    make,
                    model,
                    year,
                    color,
                    salesPerson: salesPersonId,
                    stage,
                    voyageType,
                    shipName,
                    eta,
                    notes,
                    photoUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('cars').add(newCar);
                
                // Reset form
                addCarForm.reset();
                document.getElementById('carETA').valueAsDate = new Date(new Date().getTime() + 24 * 60 * 60 * 1000); // Tomorrow
                etaType.value = 'date';
                carETA.disabled = false;
                carETA.required = true;
                voyageTypeContainer.classList.add('hidden');
                shipNameContainer.classList.add('hidden');
                
                // Reset photo
                carPhotoFile = null;
                photoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
                removePhotoBtn.classList.add('hidden');
                carPhotoInput.value = '';
                
                // Show success message
                showAdminSuccess(`Vehicle ${make} ${model} added successfully`);
                
                // Reload cars
                await loadCars();
                
            } catch (error) {
                console.error('Error adding vehicle:', error);
                showAdminError('Error adding vehicle: ' + error.message);
            } finally {
                // Hide loading spinner
                submitBtn.disabled = false;
                addCarSpinner.classList.add('hidden');
            }
        }
        
     // Add a new hot deal
async function addHotDeal(e) {
    e.preventDefault();
    
    // Get form values
    const make = document.getElementById('hotDealMake').value.trim();
    const model = document.getElementById('hotDealModel').value.trim();
    const year = parseInt(document.getElementById('hotDealYear').value);
    const color = document.getElementById('hotDealColor').value.trim();
    const budget = document.getElementById('hotDealBudget').value.trim();
    const salesAgentId = document.getElementById('hotDealAgent').value;
    const notes = document.getElementById('hotDealNotes').value.trim();
    
    // Validate required fields
    if (!make || !model || !year || !color || !salesAgentId) {
        showHotDealError('Please fill in all required fields');
        return;
    }
    
    // Parse budget if provided
    let budgetValue = null;
    if (budget) {
        budgetValue = parseInt(budget);
        if (isNaN(budgetValue) || budgetValue < 0) {
            showHotDealError('Budget must be a valid positive number');
            return;
        }
    }
    
    // Show loading spinner
    const submitBtn = hotDealForm.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    hotDealSpinner.classList.remove('hidden');
    
    try {
        // Upload photo if exists
        let photoUrl = null;
        if (hotDealPhotoFile) {
            const fileName = `hot_deals/${Date.now()}_${hotDealPhotoFile.name}`;
            const storageRef = storage.ref(fileName);
            const snapshot = await storageRef.put(hotDealPhotoFile);
            photoUrl = await snapshot.ref.getDownloadURL();
        }
        
        // Create hot deal object
        const newHotDeal = {
            make,
            model,
            year,
            color,
            salesAgent: salesAgentId,
            notes,
            photoUrl,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add budget only if provided
        if (budgetValue !== null) {
            newHotDeal.budget = budgetValue;
        }
        
        const docRef = await db.collection('hotDeals').add(newHotDeal);
        
        // Reset form
        hotDealForm.reset();
        
        // Reset photo
        hotDealPhotoFile = null;
        hotDealPhotoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
        removeHotDealPhotoBtn.classList.add('hidden');
        hotDealPhotoInput.value = '';
        
        // Hide form
        addHotDealForm.classList.add('hidden');
        
        // Show success message
        showHotDealSuccess(`Hot deal ${make} ${model} added successfully`);
        
        // Reload deals
        await loadDeals();
        
    } catch (error) {
        console.error('Error adding hot deal:', error);
        showHotDealError('Error adding hot deal: ' + error.message);
    } finally {
        // Hide loading spinner
        submitBtn.disabled = false;
        hotDealSpinner.classList.add('hidden');
    }
}
        
        // Add a new deposit
        async function addDeposit(e) {
            e.preventDefault();
            
            // Get form values
            const make = document.getElementById('depositMake').value.trim();
            const model = document.getElementById('depositModel').value.trim();
            const year = parseInt(document.getElementById('depositYear').value);
            const color = document.getElementById('depositColor').value.trim();
            const amount = parseInt(document.getElementById('depositAmount').value);
            const salesAgentId = document.getElementById('depositAgent').value;
            const notes = document.getElementById('depositNotes').value.trim();
            
            // Validate
            if (!make || !model || !year || !color || !amount || !salesAgentId) {
                showDepositError('Please fill in all required fields');
                return;
            }
            
            if (amount <= 0) {
                showDepositError('Deposit amount must be greater than 0');
                return;
            }
            
            // Show loading spinner
            const submitBtn = depositForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            depositSpinner.classList.remove('hidden');
            
            try {
                // Upload photo if exists
                let photoUrl = null;
                if (depositPhotoFile) {
                    const fileName = `deposits/${Date.now()}_${depositPhotoFile.name}`;
                    const storageRef = storage.ref(fileName);
                    const snapshot = await storageRef.put(depositPhotoFile);
                    photoUrl = await snapshot.ref.getDownloadURL();
                }
                
                // Create deposit object
                const newDeposit = {
                    make,
                    model,
                    year,
                    color,
                    amount,
                    salesAgent: salesAgentId,
                    notes,
                    photoUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('deposits').add(newDeposit);
                
                // Reset form
                depositForm.reset();
                
                // Reset photo
                depositPhotoFile = null;
                depositPhotoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
                removeDepositPhotoBtn.classList.add('hidden');
                depositPhotoInput.value = '';
                
                // Hide form
                addDepositForm.classList.add('hidden');
                
                // Show success message
                showDepositSuccess(`Deposit for ${make} ${model} added successfully`);
                
                // Reload deals
                await loadDeals();
                
            } catch (error) {
                console.error('Error adding deposit:', error);
                showDepositError('Error adding deposit: ' + error.message);
            } finally {
                // Hide loading spinner
                submitBtn.disabled = false;
                depositSpinner.classList.add('hidden');
            }
        }
        
        // Move hot deal to deposits
        async function moveHotDealToDeposits(hotDealId) {
            const deal = hotDeals.find(d => d.id === hotDealId);
            if (!deal) return;
            
            // Show loading
            showHotDealSuccess('Moving to deposits...');
            
            try {
                // Create deposit from hot deal
                const newDeposit = {
                    make: deal.make,
                    model: deal.model,
                    year: deal.year,
                    color: deal.color,
                    amount: 0, // Default amount, can be updated later
                    salesAgent: deal.salesAgent,
                    notes: deal.notes,
                    photoUrl: deal.photoUrl,
                    originalHotDealId: deal.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add to deposits
                await db.collection('deposits').add(newDeposit);
                
                // Delete from hot deals
                await db.collection('hotDeals').doc(hotDealId).delete();
                
                // Show success message
                showDepositSuccess(`Hot deal moved to deposits successfully`);
                
                // Reload deals
                await loadDeals();
                
            } catch (error) {
                console.error('Error moving hot deal to deposits:', error);
                showHotDealError('Error moving to deposits: ' + error.message);
            }
        }
        
        // Import hot deal to deposits from modal
        async function importHotDealToDeposits() {
            if (!selectedHotDealForImport) {
                showDepositError('Please select a hot deal to import');
                return;
            }
            
            const deal = hotDeals.find(d => d.id === selectedHotDealForImport);
            if (!deal) return;
            
            // Show loading spinner
            confirmImport.disabled = true;
            importSpinner.classList.remove('hidden');
            
            try {
                // Create deposit from hot deal
                const newDeposit = {
                    make: deal.make,
                    model: deal.model,
                    year: deal.year,
                    color: deal.color,
                    amount: 0, // Default amount, can be updated later
                    salesAgent: deal.salesAgent,
                    notes: deal.notes,
                    photoUrl: deal.photoUrl,
                    originalHotDealId: deal.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add to deposits
                await db.collection('deposits').add(newDeposit);
                
                // Delete from hot deals
                await db.collection('hotDeals').doc(selectedHotDealForImport).delete();
                
                // Close modal
                importHotDealsModal.classList.add('hidden');
                
                // Show success message
                showDepositSuccess(`Hot deal imported to deposits successfully`);
                
                // Reload deals
                await loadDeals();
                
            } catch (error) {
                console.error('Error importing hot deal to deposits:', error);
                showDepositError('Error importing to deposits: ' + error.message);
            } finally {
                // Hide loading spinner
                confirmImport.disabled = false;
                importSpinner.classList.add('hidden');
                selectedHotDealForImport = null;
            }
        }
        
        // Move deposit to finalised deals
        async function moveDepositToFinalised(depositId) {
            const deposit = deposits.find(d => d.id === depositId);
            if (!deposit) return;
            
            // Show loading
            showDepositSuccess('Finalising deal...');
            
            try {
                // Create finalised deal from deposit
                const newFinalisedDeal = {
                    make: deposit.make,
                    model: deposit.model,
                    year: deposit.year,
                    color: deposit.color,
                    salesAgent: deposit.salesAgent,
                    notes: deposit.notes,
                    photoUrl: deposit.photoUrl,
                    depositAmount: deposit.amount,
                    originalDepositId: deposit.id,
                    finalisedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add to finalised deals
                await db.collection('finalisedDeals').add(newFinalisedDeal);
                
                // Delete from deposits
                await db.collection('deposits').doc(depositId).delete();
                
                // Show success message
                showDepositSuccess(`Deal finalised successfully`);
                
                // Reload deals
                await loadDeals();
                
            } catch (error) {
                console.error('Error moving deposit to finalised:', error);
                showDepositError('Error finalising deal: ' + error.message);
            }
        }
        
        // Edit car function
        async function editCar(carId) {
            const car = allCars.find(c => c.id === carId);
            if (!car) return;
            
            editCarId = carId;
            
            // Populate edit form
            document.getElementById('editCarMake').value = car.make;
            document.getElementById('editCarModel').value = car.model;
            document.getElementById('editCarYear').value = car.year;
            document.getElementById('editCarColor').value = car.color;
            document.getElementById('editCarSalesPerson').value = car.salesPerson;
            document.getElementById('editCarStage').value = car.stage;
            
            // Handle voyage type
            if (car.stage === 'On voyage') {
                document.getElementById('editVoyageTypeContainer').classList.remove('hidden');
                document.getElementById('editShipNameContainer').classList.remove('hidden');
                if (car.voyageType) {
                    document.querySelector(`input[name="editVoyageType"][value="${car.voyageType}"]`).checked = true;
                }
                if (car.shipName) {
                    document.getElementById('editCarShipName').value = car.shipName;
                }
            }
            
            // Handle ETA
            if (car.eta === 'No ETA Available') {
                document.getElementById('editEtaType').value = 'none';
                document.getElementById('editCarETA').value = '';
                document.getElementById('editCarETA').disabled = true;
            } else {
                document.getElementById('editEtaType').value = 'date';
                document.getElementById('editCarETA').value = car.eta;
                document.getElementById('editCarETA').disabled = false;
            }
            
            // Handle notes
            document.getElementById('editCarNotes').value = car.notes || '';
            
            // Handle photo preview
            if (car.photoUrl) {
                editPhotoPreview.innerHTML = `<img src="${car.photoUrl}" alt="${car.make} ${car.model}" class="photo-preview">`;
            } else {
                editPhotoPreview.innerHTML = '<i class="fas fa-car text-4xl"></i>';
            }
            
            // Show edit form
            editCarFormContainer.classList.add('expanded');
            
            // Scroll to edit form
            editCarFormContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Edit car form submission
        async function editCarSubmit(e) {
            e.preventDefault();
            
            if (!editCarId) return;
            
            // Get form values
            const make = document.getElementById('editCarMake').value.trim();
            const model = document.getElementById('editCarModel').value.trim();
            const year = parseInt(document.getElementById('editCarYear').value);
            const color = document.getElementById('editCarColor').value.trim();
            const salesPersonId = document.getElementById('editCarSalesPerson').value;
            const stage = document.getElementById('editCarStage').value;
            const eta = editEtaType.value === 'none' ? 'No ETA Available' : document.getElementById('editCarETA').value;
            const notes = document.getElementById('editCarNotes').value.trim();
            
            // Validate
            if (!make || !model || !year || !color || !salesPersonId || !stage || !eta) {
                showAdminError('Please fill in all required fields');
                return;
            }
            
            if (editEtaType.value === 'date' && !document.getElementById('editCarETA').value) {
                showAdminError('Please select an ETA date');
                return;
            }
            
            // Get voyage type if applicable
            let voyageType = null;
            let shipName = null;
            if (stage === 'On voyage') {
                const voyageTypeRadio = document.querySelector('input[name="editVoyageType"]:checked');
                voyageType = voyageTypeRadio ? voyageTypeRadio.value : null;
                shipName = document.getElementById('editCarShipName').value.trim();
            }
            
            // Show loading spinner
            const submitBtn = editCarForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            editCarSpinner.classList.remove('hidden');
            
            try {
                // Upload new photo if exists
                let photoUrl = null;
                const car = allCars.find(c => c.id === editCarId);
                
                if (editCarPhotoFile) {
                    const fileName = `car_photos/${Date.now()}_${editCarPhotoFile.name}`;
                    const storageRef = storage.ref(fileName);
                    const snapshot = await storageRef.put(editCarPhotoFile);
                    photoUrl = await snapshot.ref.getDownloadURL();
                } else {
                    photoUrl = car.photoUrl; // Keep existing photo
                }
                
                // Update car object
                const updateData = {
                    make,
                    model,
                    year,
                    color,
                    salesPerson: salesPersonId,
                    stage,
                    voyageType,
                    shipName,
                    eta,
                    notes,
                    photoUrl,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('cars').doc(editCarId).update(updateData);
                
                // Show success message
                showAdminSuccess(`Vehicle ${make} ${model} updated successfully`);
                
                // Reload cars
                await loadCars();
                
                // Close edit form
                editCarFormContainer.classList.remove('expanded');
                editCarId = null;
                editCarPhotoFile = null;
                
            } catch (error) {
                console.error('Error updating vehicle:', error);
                showAdminError('Error updating vehicle: ' + error.message);
            } finally {
                // Hide loading spinner
                submitBtn.disabled = false;
                editCarSpinner.classList.add('hidden');
            }
        }
        
        // Update car stage
        async function updateCarStage() {
            if (!currentCarIdForUpdate) return;
            
            const newStage = newStageSelect.value;
            const car = allCars.find(c => c.id === currentCarIdForUpdate);
            if (!car) return;
            
            // Get additional data if needed
            let voyageType = car.voyageType;
            let shipName = car.shipName;
            
            if (newStage === 'On voyage') {
                const voyageTypeRadio = document.querySelector('input[name="voyageTypeModal"]:checked');
                voyageType = voyageTypeRadio ? voyageTypeRadio.value : null;
                shipName = document.getElementById('newShipName').value.trim();
            }
            
            // Show loading spinner
            const confirmBtn = document.getElementById('confirmUpdateStage');
            confirmBtn.disabled = true;
            document.getElementById('updateStageSpinner').classList.remove('hidden');
            
            try {
                const updateData = {
                    stage: newStage,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add voyage type and ship name if changing to On voyage
                if (newStage === 'On voyage') {
                    updateData.voyageType = voyageType;
                    if (shipName) updateData.shipName = shipName;
                }
                
                await db.collection('cars').doc(currentCarIdForUpdate).update(updateData);
                
                // Close modal
                updateStageModal.classList.add('hidden');
                
                // Show success message
                showAdminSuccess(`Vehicle stage updated to "${newStage}"`);
                
                // Reload cars
                await loadCars();
                
                // If marked as delivered, also update successful deliveries tab
                if (newStage === 'Delivered') {
                    displaySuccessfulDeliveries();
                }
                
            } catch (error) {
                console.error('Error updating vehicle stage:', error);
                showAdminError('Error updating vehicle stage: ' + error.message);
            } finally {
                // Hide loading spinner
                confirmBtn.disabled = false;
                document.getElementById('updateStageSpinner').classList.add('hidden');
                currentCarIdForUpdate = null;
            }
        }
        
        // Update car ETA
        async function updateCarETA() {
            if (!currentCarIdForETA) return;
            
            const newETA = newETADate.value;
            if (!newETA) {
                showAdminError('Please select a date');
                return;
            }
            
            // Show loading spinner
            const confirmBtn = document.getElementById('confirmUpdateETA');
            confirmBtn.disabled = true;
            document.getElementById('updateETASpinner').classList.remove('hidden');
            
            try {
                await db.collection('cars').doc(currentCarIdForETA).update({
                    eta: newETA,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Close modal
                updateETAModal.classList.add('hidden');
                
                // Show success message
                showAdminSuccess(`Vehicle ETA updated to ${formatDate(newETA)}`);
                
                // Reload cars
                await loadCars();
                
            } catch (error) {
                console.error('Error updating vehicle ETA:', error);
                showAdminError('Error updating vehicle ETA: ' + error.message);
            } finally {
                // Hide loading spinner
                confirmBtn.disabled = false;
                document.getElementById('updateETASpinner').classList.add('hidden');
                currentCarIdForETA = null;
            }
        }
        
        // Confirm delete action
        async function confirmDelete() {
            if (!currentItemIdForDelete || !currentDeleteType) return;
            
            // Show loading spinner
            const confirmBtn = document.getElementById('confirmDelete');
            confirmBtn.disabled = true;
            document.getElementById('deleteSpinner').classList.remove('hidden');
            
            try {
                if (currentDeleteType === 'car') {
                    await db.collection('cars').doc(currentItemIdForDelete).delete();
                    showAdminSuccess('Vehicle deleted successfully');
                } else if (currentDeleteType === 'salesPerson') {
                    // Check if sales person has assigned vehicles
                    const person = salesPeople.find(p => p.id === currentItemIdForDelete);
                    if (person && (person.vehicleCount || 0) > 0) {
                        throw new Error('Cannot delete sales person with assigned vehicles');
                    }
                    
                    await db.collection('salesPeople').doc(currentItemIdForDelete).delete();
                    showAdminSuccess('Sales person deleted successfully');
                } else if (currentDeleteType === 'hotDeal') {
                    await db.collection('hotDeals').doc(currentItemIdForDelete).delete();
                    showHotDealSuccess('Hot deal deleted successfully');
                } else if (currentDeleteType === 'deposit') {
                    await db.collection('deposits').doc(currentItemIdForDelete).delete();
                    showDepositSuccess('Deposit deleted successfully');
                } else if (currentDeleteType === 'finalisedDeal') {
                    await db.collection('finalisedDeals').doc(currentItemIdForDelete).delete();
                    showAdminSuccess('Finalised deal deleted successfully');
                }
                
                // Close modal
                deleteModal.classList.add('hidden');
                
                // Reload data
                if (currentDeleteType === 'car') {
                    await loadCars();
                } else if (currentDeleteType === 'salesPerson') {
                    await loadSalesPeople();
                } else if (currentDeleteType === 'hotDeal' || currentDeleteType === 'deposit' || currentDeleteType === 'finalisedDeal') {
                    await loadDeals();
                }
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showAdminError('Error deleting: ' + error.message);
            } finally {
                // Hide loading spinner
                confirmBtn.disabled = false;
                document.getElementById('deleteSpinner').classList.add('hidden');
                currentItemIdForDelete = null;
                currentDeleteType = null;
            }
        }
        
        // Filter cars based on search and stage filter
        function filterCars() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedStage = filterStage.value;
            
            // Filter cars (excluding delivered ones for the main view)
            let filteredCars = allCars.filter(car => car.stage !== 'Delivered');
            
            if (searchTerm) {
                filteredCars = filteredCars.filter(car => {
                    const salesPerson = salesPeople.find(p => p.id === car.salesPerson);
                    const salesPersonName = salesPerson ? salesPerson.name.toLowerCase() : '';
                    
                    return (
                        car.make.toLowerCase().includes(searchTerm) || 
                        car.model.toLowerCase().includes(searchTerm) ||
                        car.color.toLowerCase().includes(searchTerm) ||
                        salesPersonName.includes(searchTerm)
                    );
                });
            }
            
            if (selectedStage) {
                filteredCars = filteredCars.filter(car => car.stage === selectedStage);
            }
            
            // Update UI
            if (filteredCars.length === 0) {
                allCarsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-search text-3xl mb-4"></i>
                        <p class="text-lg">No vehicles found</p>
                        <p class="text-sm">Try adjusting your search or filter</p>
                    </div>
                `;
                return;
            }
            
            allCarsContainer.innerHTML = '';
            filteredCars.forEach(car => {
                const card = createCarCard(car);
                allCarsContainer.appendChild(card);
            });
        }
        
        // Initialize stage filters
        function initializeStageFilters() {
            const stages = [
                'Due to ship', 'On voyage', 'On port', 'Clearing', 'Due to carrier',
                'On carrier', 'On transit to Nairobi', 'Arrived to Nairobi',
                'Due for delivery', 'Delivered', 'Due for sale in Nairobi',
                'Picked by client from Mombasa'
            ];
            
            const container = document.getElementById('stageFilterButtons');
            
            stages.forEach(stage => {
                const button = document.createElement('button');
                button.className = 'stage-filter-btn px-3 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-800 hover:bg-gray-300 transition';
                button.textContent = stage;
                button.setAttribute('data-stage', stage);
                
                button.addEventListener('click', function() {
                    const selectedStage = this.getAttribute('data-stage');
                    
                    // Update active button
                    document.querySelectorAll('.stage-filter-btn').forEach(btn => {
                        btn.classList.remove('bg-kenya-green-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-800');
                    });
                    
                    this.classList.remove('bg-gray-200', 'text-gray-800');
                    this.classList.add('bg-kenya-green-600', 'text-white');
                    
                    // Filter cars
                    filterCarsByStage(selectedStage);
                });
                
                container.appendChild(button);
            });
        }
        
        // Filter cars by stage
        function filterCarsByStage(stage) {
            const cars = allCars.filter(car => car.stage !== 'Delivered');
            
            if (stage === '') {
                displayAllCars();
                return;
            }
            
            const filteredCars = cars.filter(car => car.stage === stage);
            
            if (filteredCars.length === 0) {
                allCarsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-car text-3xl mb-4"></i>
                        <p class="text-lg">No vehicles in "${stage}" stage</p>
                    </div>
                `;
                return;
            }
            
            allCarsContainer.innerHTML = '';
            filteredCars.forEach(car => {
                const card = createCarCard(car);
                allCarsContainer.appendChild(card);
            });
        }
        
        // Show admin error message
        function showAdminError(message) {
            adminError.textContent = message;
            adminError.classList.remove('hidden');
            adminSuccess.classList.add('hidden');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                adminError.classList.add('hidden');
            }, 5000);
        }
        
        // Show admin success message
        function showAdminSuccess(message) {
            adminSuccess.textContent = message;
            adminSuccess.classList.remove('hidden');
            adminError.classList.add('hidden');
            
            // Hide success after 5 seconds
            setTimeout(() => {
                adminSuccess.classList.add('hidden');
            }, 5000);
        }
        
        // Show hot deal error message
        function showHotDealError(message) {
            hotDealError.textContent = message;
            hotDealError.classList.remove('hidden');
            hotDealSuccess.classList.add('hidden');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                hotDealError.classList.add('hidden');
            }, 5000);
        }
        
        // Show hot deal success message
        function showHotDealSuccess(message) {
            hotDealSuccess.textContent = message;
            hotDealSuccess.classList.remove('hidden');
            hotDealError.classList.add('hidden');
            
            // Hide success after 5 seconds
            setTimeout(() => {
                hotDealSuccess.classList.add('hidden');
            }, 5000);
        }
        
        // Show deposit error message
        function showDepositError(message) {
            depositError.textContent = message;
            depositError.classList.remove('hidden');
            depositSuccess.classList.add('hidden');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                depositError.classList.add('hidden');
            }, 5000);
        }
        
        // Show deposit success message
        function showDepositSuccess(message) {
            depositSuccess.textContent = message;
            depositSuccess.classList.remove('hidden');
            depositError.classList.add('hidden');
            
            // Hide success after 5 seconds
            setTimeout(() => {
                depositSuccess.classList.add('hidden');
            }, 5000);
        }
        
        // Helper function to get stage CSS class
        function getStageClass(stage) {
            switch(stage) {
                case 'Due to ship': return 'stage-due-to-ship';
                case 'On voyage': return 'stage-on-voyage';
                case 'On port': return 'stage-on-port';
                case 'Clearing': return 'stage-clearing';
                case 'Due to carrier': return 'stage-due-to-carrier';
                case 'On carrier': return 'stage-on-carrier';
                case 'On transit to Nairobi': return 'stage-on-transit';
                case 'Arrived to Nairobi': return 'stage-arrived';
                case 'Due for delivery': return 'stage-due-for-delivery';
                case 'Delivered': return 'stage-delivered';
                case 'Due for sale in Nairobi': return 'stage-due-for-sale';
                case 'Picked by client from Mombasa': return 'stage-picked-by-client';
                default: return 'bg-gray-500 text-white';
            }
        }
        
        // Helper function to get indicator CSS class
        function getIndicatorClass(stage) {
            switch(stage) {
                case 'Due to ship': return 'indicator-due-to-ship';
                case 'On voyage': return 'indicator-on-voyage';
                case 'On port': return 'indicator-on-port';
                case 'Clearing': return 'indicator-clearing';
                case 'Due to carrier': return 'indicator-due-to-carrier';
                case 'On carrier': return 'indicator-on-carrier';
                case 'On transit to Nairobi': return 'indicator-on-transit';
                case 'Arrived to Nairobi': return 'indicator-arrived';
                case 'Due for delivery': return 'indicator-due-for-delivery';
                case 'Delivered': return 'indicator-delivered';
                case 'Due for sale in Nairobi': return 'indicator-due-for-sale';
                case 'Picked by client from Mombasa': return 'indicator-picked-by-client';
                default: return 'bg-gray-500';
            }
        }
        
        // Helper function to get stage icon
        function getStageIcon(stage) {
            switch(stage) {
                case 'Due to ship': return '';
                case 'On voyage': return '';
                case 'On port': return '';
                case 'Clearing': return '';
                case 'Due to carrier': return '';
                case 'On carrier': return '';
                case 'On transit to Nairobi': return '';
                case 'Arrived to Nairobi': return '';
                case 'Due for delivery': return '';
                case 'Delivered': return '';
                case 'Due for sale in Nairobi': return '';
                case 'Picked by client from Mombasa': return '';
                default: return '';
            }
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString || dateString === 'No ETA Available') return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Helper function to format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Helper function to calculate days until ETA
        function calculateDaysUntilETA(eta) {
            if (!eta || eta === 'No ETA Available') return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const etaDate = new Date(eta);
            etaDate.setHours(0, 0, 0, 0);
            const diffTime = etaDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
    </script>
</body>
</html>
